---
id: agent-weaving
title: オープンソース追跡
description: Javaアプリケーションで使用するフレームワークやオープンソースライブラリをエージェントを介して追跡する設定方法を提供します。 Javaエージェント設定ファイル(whatap.conf)にweavingオプションを追加して設定し、様々なフレームワーク及びライブラリバージョンに対応する方法を案内します。
keywords:
  - Java
  - エージェント
  - オープンソース追跡
  - Weaving
---

Javaアプリケーションで使用するフレームワークやオープンソースライブラリをエージェントを介して追跡する設定方法を提供します。 これはJavaエージェント設定ファイル(*whatap.conf*)ファイルに`weaving`オプションを追加して設定し、様々なフレームワークやライブラリバージョンに対応する方法を案内します。

たとえば、フレームワークやオープンソースでspring-boot-3.x、feign-client-11、okhttp3-4.4使用の際は、次のようにオプションを設定します。

```ini title='whatap.conf'
weaving=spring-boot-3.0,feign-11,okhttp3-4.4
```

## 対応オープンソースの一覧

Javaエージェントを通じて追跡しているフレームワーク、またはオープンソースに対する設定方法は以下を参照してください。

### Apache Camel

#### CXF
| エージェントバージョン | camel-cxf-3.15以上 |
| --------------------- | :----------------: |
| v2.2.27               |         ✅         |

#### Netty
| エージェントバージョン | camel-netty4-2.25以上 |
| --------------------- | :-------------------: |
| v2.2.42               |          ✅           |

#### SEDA
| エージェントバージョン | camel-seda-2.22以上 | camel-seda-3.2以上 |
| --------------------- | :-----------------: | :----------------: |
| v2.2.20               |         ✅          |         ✅         |

### DB2
| エージェントバージョン | db2-11.5以上 |
| --------------------- | :----------: |
| v2.2.18               |      ✅      |

### DynamoDB
| エージェントバージョン | dynamodb-1.11 | dynamodb-2.25 |
| --------------------- | :-----------: | :-----------: |
| v2.2.39               |      ✅       |      ✅       |

### Feign Client
| エージェントバージョン | feign-11以上 |
| --------------------- | :----------: |
| v2.2.6                |      ✅      |

### Hystrix
| エージェントバージョン | hystrix-1.5以上 |
| --------------------- | :-------------: |
| v2.0_21               |       ✅        |

### Kafka
| エージェントバージョン | kafka-clients-2.4.0以上 | reactor-kafka-1.3以上 |
| --- | :---: | :---: |
| v2.2.15 | ✅ | ❌ |
| v2.2.5 | ❌ | ✅ |

### ロギング

#### Log4j2
| エージェントバージョン | log4j-2.17以上 |
| --- | :---: |
| **備考** | [特定のappenderを除外するエージェントオプション提供](agent-log#excludeappender) |
| v2.2.28 | ✅ |

#### Logback
| エージェントバージョン | logback-1.2.8以上 |
| --- | :---: |
| **備考** | [特定のappenderを除外するエージェントオプション提供](agent-log#excludeappender) |
| v2.2.28 | ✅ |

### MongoDB
| エージェントバージョン | 3.8.2以上 | 4.0.3以上 | 4.4以上 | 4.8以上 | 4.11以上 | 5.0以上 |
| --- | :---: | :---: | :---: | :---: | :---: | :---: |
| v2.2.45 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| v2.2.11 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

### Mule Framework
| エージェントバージョン | mule-3.9.5以上 | mule-4.5以上 |
| --- | :---: | :---: |
| v2.2.23 | ✅ | ✅ |

### OkHttp
| エージェントバージョン | okhttp-2.7以上 | okhttp3 | okhttp3-4.4 |
| --- | :---: | :---: | :---: |
| v2.2.9 | ✅ | ✅ | ✅ |
| v2.0_15 | ✅ | ✅ | ❌ |

### Quarkus Reactive
| エージェントバージョン | quarkus-reactive-1.13以上 | quarkus-reactive-2.10以上 |
| --- | :---: | :---: |
| v2.2.19 | ✅ | ✅ |

### RabbitMQ
| エージェントバージョン | reactor-rabbitmq-1.2以上 |
| --- | :---: |
| v2.0_06 | ✅ |

### Redis

#### Jedis
| エージェントバージョン | jedis-2.9.0以上 | jedis-2.9.3以上 | jedis-3.2以上 |
| --- | :---: | :---: | :---: |
| v2.2.43 | ✅ | ✅ | ✅ |
| v2.0_33 | ❌ | ✅ | ✅ |
| v2.0_09 | ❌ | ❌ | ✅ |

#### Lettuce
| エージェントバージョン | lettuce-5.1以上 | lettuce-6.2以上 |
| --- | :---: | :---: |
| v2.2.16 | ✅ | ✅ |
| v2.2.7 | ✅ | ❌ |

### Retrofit
| エージェントバージョン | retrofit-2.5以上 |
| --- | :---: |
| **備考** | okhttp設定と同時使用不可 |
| v2.2.39 | ✅ |

### Ribbon
| エージェントバージョン | ribbon |
| --- | :---: |
| v2.2.10 | ✅ |

### Spring Boot
| エージェントバージョン | 2.1以上 | 2.5以上 | 2.7以上 | 3.0以上 | 3.2以上 |
| --- | :---: | :---: | :---: | :---: | :---: |
| v2.2.38 | ✅ | ✅ | ✅ | ✅ | ✅ |
| v2.2.23 | ✅ | ❌ | ❌ | ❌ | ❌ |
| v2.2.9 | ❌ | ✅ | ✅ | ✅ | ❌ |

<details>
<summary>含まれる技術スタックを表示</summary>

- **spring-boot-2.1**: r2dbc-mysql-0.8.2, spring-cloud-gateway-2.1, spring-kafka-2.7, spring-webflux-5.1, tomcat9
- **spring-boot-2.5**: r2dbc-mysql-0.8.2, spring-cloud-gateway-3.0, spring-kafka-2.7, spring-webflux-5.3, mongodb-4.0.3, reactor-kafka-1.3, rxjava2, tomcat9
- **spring-boot-2.7**: jasync-r2dbc-mysql-2.1.23, r2dbc-mysql-0.9.3, spring-cloud-gateway-3.1, spring-kafka-3.0, spring-webflux-5.3, mongodb-4.4, reactor-kafka-1.3, rxjava2, tomcat9
- **spring-boot-3.0**: jasync-r2dbc-mysql-2.1.23, r2dbc-mysql-1.0.2, spring-cloud-gateway-4.0, spring-kafka-3.0, spring-webflux-6.0, mongodb-4.8, redis(lettuce-6.2), reactor-kafka-1.3, rxjava3, tomcat10
- **spring-boot-3.2**: jasync-r2dbc-mysql-2.1.23, r2dbc-mysql-1.1.3, spring-cloud-gateway-4.1, spring-kafka-3.1, spring-webflux-6.1, redis(lettuce-6.2), reactor-kafka-1.3, rxjava3, tomcat10

</details>

### Tomcat
| エージェントバージョン | tomcat9 | tomcat10 |
| --- | :---: | :---: |
| v2.2.5 | ✅ | ✅ |

### Undertow
| エージェントバージョン | undertow-2.2以上 | undertow-2.3以上 |
| --- | :---: | :---: |
| v2.2.39 | ✅ | ✅ |
| v2.2.14 | ❌ | ✅ |

### Vert.x
| エージェントバージョン | vertx-3.5.3 | vertx-3.9 | vertx-4.5 |
| --- | :---: | :---: | :---: |
| v2.2.44 | ✅ | ✅ | ✅ |
| v2.2.42 | ✅ | ❌ | ❌ |
| v2.2.39 | ❌ | ❌ | ✅ |


## JavaエージェントのCVE誤検知防止

Javaエージェントに含まれるライブラリクラスは、アプリケーションで実際に使用される場合にのみロードされます。CVE脆弱性スキャンでライブラリが検出されても、使用していなければ実際の脆弱性はありません。

不要なトラッキングクラスを削除するには、次のコマンドを実行してください。
```bash
java -cp whatap.agent-X.Y.Z.jar whatap.agent.setup.RemoveWeaving -remove [weaving jar filename]
```

:::caution
Javaエージェントの更新ごとに削除作業を再度実行する必要があります。
:::

:::note

特定のライブラリクラスを削除するコマンドは**Javaエージェント2.2.37バージョン**以降で対応します。

**使い方**：`java -cp whatap.agent-X.Y.Z.jar whatap.agent.setup.RemoveWeaving [arguments] [weaving jar filename]`

```bash title="Example"
java -cp whatap.agent-2.2.37.jar whatap.agent.setup.RemoveWeaving -remove spring-boot-2.5.jar spring-boot-2.7.jar
```

Arguments:

- `-r`または`-remove`: Javaエージェントでweaving jarファイルを削除して、新しいJavaエージェントを作成します。

- `-l`または`-list`: weaving jarのファイル一覧を出力します。

- `-d`または`-debug`: デバッグロギング(debug logging)を有効にします。

- `-e`または`-error`: エラーのフルスタックトレースの情報を表示します。

- `-h`または`-help`: ヘルプを出力して終了します。

:::
