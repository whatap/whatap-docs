---
id: about-apm-heap-memory
title: ヒープメモリメトリクス通知設定
description: WhaTapアプリケーションモニタリングのヒープメモリ関連指標とメトリクス通知設定について案内します。
keywords:
  - ヒープメモリ
  - メトリクスアラート
  - Java
  - アプリケーションモニタリング
displayed_sidebar: learningSidebar
---

:::note 

次のJava公式文書へのリンクを参照してください。 

- [Java SE 22](https://docs.oracle.com/en/java/javase/22/)

- [Java Memory Usage](https://docs.oracle.com/javase/8/docs/api/java/lang/management/MemoryUsage.html)

:::

アプリケーションプロジェクトのヒープメモリ関連のメトリクスとメトリクス通知設定について案内します。

## ヒープメモリメトリクス{#heap-memory-intro}

ヒープメモリ(HeapMemory)は、Java仮想マシン(JVM)がプログラムを実行するために割り当てたデータ保存領域で、インスタンスや配列などの主要データを保存します。 ヒープエリアは、インスタンスのライフサイクルおよびGCと密接な関係を持ちます。 GCは不要なインスタンスをヒープ領域から解除し、ヒープ領域の空き領域を確保する作業です。 

<ImgLang img='best-p/about-heap-memory.png' desc='ヒープメモリーウィジェット' />

ヒープメモリ関連指標を通じてサーバー別の最大ヒープメモリ、現在のヒープメモリを確認し、状況を監視することができます。 また、最大値と現在値のギャップを把握し、適切にヒープメモリを設定することができます。 ヒープメモリ使用量の最小値が持続的に上昇する場合、メモリリークが疑われる可能性があります。

### メトリクス照会

ホーム画面 > プロジェクト選択 > ***サイトマップ*** > ***分析*** > ***メトリクス照会***

***メトリクス照会***メニューで確認できるヒープメモリ関連指標を案内します。 

#### Heap Memory

`app_proc_counter`カテゴリーの選択後、確認できます。

- **Heapコミット**`heap_committed`

  JVMが使用できるようにコミットされたヒープメモリを意味します。

- **初期Heap**`heap_init`

  JVMがメモリ管理のためにOSにリクエストした最初のヒープメモリを意味します。

- **Heap最大サイズ**`heap_max`

  JVMがメモリ管理に使用できる最大ヒープメモリを意味します。

- **Heap使用量**`heap_used`

  JVMで使用中のヒープメモリを意味します。

- **Heap総使用量**`heap_use`

  JVMが割り当てられたヒープメモリの総量を意味します。

#### Non-heap Memory

`java_memory`カテゴリーの選択後、確認できます。

- **Heapコミット**`nonheap_committed`

  JVMがメモリ管理のためにOSにリクエストした最初の非ヒープメモリを意味します。

- **最初Non-heap**`nonheap_init`

  JVMがメモリ管理のためにOSにリクエストした最初の非ヒープメモリを意味します。

- **Non-heap総使用量**`nonheap_max`

  JVMでメモリ管理に使用できる最大の非ヒープメモリ使用量を意味します。 

  :::note 

  Metaspace及びJITコードキャッシュ最大メモリサイズが定義されていない場合は`-1`を返します。 

  :::

- **Non-heap使用量**`nonheap_used`

  JVMで使用された非ヒープメモリを意味します。

### メトリクスチャート

ホーム画面 > プロジェクト選択 > ***分析*** > ***メトリクスチャート***

***メトリクスチャート***メニューで確認できるヒープメモリー関連指標を案内します。

- **Heap最大サイズ**`heap_max`

  JVMがメモリ管理に使用できる最大ヒープメモリを意味します。 

- **Heap総使用量**`heap_use`

  JVMが割り当てられたヒープメモリの総量を意味します。

- **Heap使用量**`heap_use`

  JVMで使用中のヒープメモリを意味します。 

- **Heap Perm領域の使用量**`heap_perm`

  Perm領域のメモリ使用量を意味します。

- **Heap Pending Finalizationの数**`heap_pending_finalization`

  待機中のFinalizationを持っているObjectの概算の数を意味します。

:::note

アプリケーション指標については[次の文書](../java/metrics-app)を参照してください。

:::

## ヒープメモリメトリクス通知設定{#heap-memory-metrics-alert}

ホーム画面 > プロジェクト選択 > ***アラート通知*** > ***メトリクス***タブ選択

ヒープメモリ関連のアラート通知を使用するには、メトリクスアラート通知を設定する必要があります。 メトリクスアラート通知は、デフォルト通知より細かく精巧な通知設定が可能です。 詳細については、[次の文書](../java/metric-warning-notice)を参照にしてください。 以下の例では、ヒープメモリ使用量(`heap_used`)を基準にメトリクス通知を設定する方法をご案内します。

<ImgLang img='best-p/about-heap-memory-metrics-event-01.png' desc='ヒープメモリメトリクス通知設定1' />

1. ***アラート通知***下位の***イベント設定***メニューから***メトリクス***タブを選択します。

2. 画面上段右側から***+イベント追加***ボタンを選択します。

3. ***メトリクスイベント***画面の![指示線1](/img/number-01.png)領域で***イベント名***、***カテゴリ***、***レベル***、***メッセージ***、***イベント発生条件***などを設定してください。

   - ***イベント名***を入力します。 

     > Heap Memory

   - ***レベル***はイベント発生時のアラートレベルを意味します。 レベルを設定します。 基本設定は<span class='vslow'>Critical</span>レベルです。

   - ***カテゴリ***入力画面で***JavaMemory***(`java_memory`)を選択します。

   - イベント***メッセージ***を入力します。 例示メッセージの場合、ヒープメモリ使用量が設定したしきい値を超えたら、該当イベントの発生時刻とともに送信されます。

     > `${heap_used}`が`${time}`に`${metricThreshold}`を超えました。

   - フィールド、オペレーター、しきい値を入力して、***アラート通知条件***を設定します。 ヒープ使用量が50,000,000 byte超過時に通知を発生させる通知の例は次のとおりです。

     > フィールド`heap_used`、オペレーター`>`、しきい値`50000000`

4. ![指示線2](/img/number-02.png)領域で![指示線a](/img/char-a.svg)イベント受信に関する詳細要件を設定し、該当のイベント通知ルールを![指示線b](/img/char-b.svg)テストしてみてください。

   <ImgLang img='best-p/about-heap-memory-metrics-event-02.png' desc='ヒープメモリメトリクス通知設定2' />

   - ![指示線a](/img/char-a.svg)***イベント受信設定***

     - ***発生回数***は最近`n`の期間中、当該イベントが `n'`回発生した場合、通知を送信するようにします。

       > 最近`1分`の間、該当イベント`3`回発生時に通知が送信されます。

     - ***イベント発生の一時停止***は、当該通知発生後に設定した時間の間に同じ通知が発生しないようにします。 

   - ![指示線b](/img/char-b.svg)***通知ルールテスト***オプションでは、選択した期間中に該当のイベント通知設定時、何回のアラート通知が発生したかを確認できます。 

     > 過去の`60分`の間、`1分`内に続けて`3`回以上ヒープメモリ使用量(`heap_used`)が `50,000,000`byteを超えたイベント発生時に、送信した通知件数は合計***66***件です。

5. ***メトリクスイベント***画面の下段の![指示線3](/img/number-03.png)***保存*** ボタンをクリックして通知設定を完了してください。

## ヒープメモリ使用量確認{#heap-memory-use-check}

ホーム画面 > プロジェクト選択 > ***分析*** > ***メトリクスチャート***

選択した期間中のヒープメモリ使用量(`heap_used`)の詳細を確認したい場合は、***メトリクスチャート***へ移動してください。

<ImgLang img='best-p/about-heap-memory-metrics-chart-01.png' desc='メトリクスチャート' />

1. 上段の![指示線1](/img/number-01.png)タイムピッカーを通じて照会したい期間を指定してください。

2. 左側の指標一覧から![指示線2](/img/number-02.png)***カテゴリ***は***JavaMemory***(`java_memory`)を選択します。

3. ![指示線3](/img/number-03.png)***JavaMemory***カテゴリ下位から`heap_used`を選択します。 チャート領域から、例のようにヒープメモリ使用量チャートを照会することができます。

4. `heap_used`ウィジェット上段右側の***もっと見る***アイコンをクリックし、オプションメニューから***詳細***アイコンを選択すると、モニタリング対象の指標推移を個別に確認することができます。

   <ImgLang img='best-p/about-heap-memory-metrics-chart-02.png' desc='メトリクスチャート詳細 1' />

5. ***タグ***フィルターを選択すると、次のようにエージェント、エージェントグループ、エージェントホストなどを選択して個別チャートを照会することができます。

   <ImgLang img='best-p/about-heap-memory-metrics-chart-03.png' desc='メトリクスチャート詳細 2' />
