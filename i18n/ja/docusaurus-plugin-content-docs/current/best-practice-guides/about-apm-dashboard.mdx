---
id: about-apm-dashboard
title: アプリケーションダッシュボードを見る
description: アプリケーションのパフォーマンスモニタリング機能の1つであるアプリケーションダッシュボードのメニューからチャート型ウィジェットの分析方法を紹介します。
tags:
  - アプリケーション
  - アプリケーションモニタリング
  - アプリケーションダッシュボード
  - APM
keywords:
  - アプリケーション
  - アプリケーションモニタリング
  - アプリケーションダッシュボード
  - APM
displayed_sidebar: learningSidebar
---

この文書では、WhaTapモニタリングサービスの一つであるアプリケーションパフォーマンスモニタリング（Application Performance Monotoring、以下APM）の**_アプリケーションダッシュボード_**メニューからチャート型ウィジェットに対する分析方法を紹介します。Webアプリケーションサーバ（Web Application Server）の問題を**_アプリケーションダッシュボード_**でどのように把握し、分析するかを説明して見ます。アプリケーションダッシュボードの機能については、[次のドキュメント](https://docs.whatap.io/java/dashboard)を参照してください。

一つのウェブサービスは数多くのアプリケーションとプラットフォームで構成されており、アプリケーションの観点から性能を分析すると過程が複雑になります。**_アプリケーションダッシュボード_**では、次の観点から分析できるようにダッシュボードにウィジェットを追加しました。

-   アプリケーション接続のステータス： エージェント
-   トランザクション：**_スピードメーター_**、**_アクティブトランザクション_**、**_アクティブステータス_**、**_ヒットマップ_**
-   サービス： **_ Apdex_**、**_TPS_**、**_平均応答時間_**
-   リソース：**_システムCPU_**、**_ヒップメモリ_**
-   ユーザー： **_同時接続ユーザー_**
-   1日基準比較：**_本日のTPS_**、**_本日のユーザー_**

## アプリケーション接続のステータスを確認

**_アプリケーションダッシュボード_**画面上には、WhaTapモニタリングサービスに接続されたアプリケーションサーバーを確認することができます。接続されたエージェントが非アクティブになっているか、アプリケーションサーバーとの接続が切断されている場合、エージェントはグレーで表示されます。 これにより、エージェントの状態を簡単に把握できます。

![](/img/best-p/apm-dashboard-agent-01.png)

接続されたエージェントの数が多いため、全体エージェントの状態を確認するには一番右の![下方向アイコン](/img/down-arrow.svg)をクリックしてください。 接続された全体エージェントの一覧を次の画面のように展開して把握できます。

![](/img/best-p/apm-dashboard-agent-02.png)

接続されたエージェントを一行に並べて画面を効率的に利用したい場合は、エージェントの名前を短く設定することもできます。エージェント名を設定する方法の詳細については、[次の文書](https://docs.whatap.io/java/agent-name)を参照してください。

## トランザクション分析

![](/img/best-p/apm-dashboard-service.png)

ウェブアプリケーションサーバー（WAS）を利用するユーザーは、ブラウザを通じて要請したサービス（AP）の結果がきちんと実行されることを期待します。 サービス（AP）は、正しく動作するためにサーバーのリソースを利用します。 リソースとは、APプロセス、OS／HWリソース（CPU、メモリ、ディスクなど）、外部システム（Database、その他のサーバ）などを意味します。

ユーザーが望んでいる結果を得られなかったり、応答が遅い場合、障害が発生したか、パフォーマンスに問題がある場合があります。これは、サービス（AP）のプログラミングの問題である場合もあれば、リソースの問題である場合もあります。アプリケーションのモニタリングの重要な点は、問題の原因がプログラミングか、リソースか、その他の原因があるかどうかを判断することです。これを把握するために、ユーザーの要求が正しく実行されたかどうかを確認するプロセスが必要です。ユーザーの要求、一つずつをRequestと呼び、このRequestをサーバーで処理し、ユーザーに応答する過程を**トランザクション（Transaction）**と定義します。

**トランザクション（Transaction）**とは、ユーザブラウザのリクエストを処理するためのサーバサイドのLUW（Logical Unit of Work）を意味します。 個々のウェブサービス（URL）リクエストに対する処理プロセスがトランザクションです。 ウェブアプリケーションでトランザクションは、ウェブサービスに対するHTTPリクエストを受けて応答（Response）を返す過程です。 WhaTapは、トランザクションの名前をURLとして保存します。 たとえば、ブラウザリクエストURLがhttps://www.whatap.io/hr/apply.do?name='kim' の場合、トランザクション名は`/hr/apply.do` です。

トランザクションがどれだけ早く、エラーなく処理されるかは、**サービスの応答がエラーなく処理されるか**と同じ意味で解釈できます。 トランザクションは、「進行中のトランザクション」と「終了したトランザクション」に分けられます。 「進行中のトランザクション」とは、リクエストを送信したが応答を受けていない状態を意味し、「終了したトランザクション」とは、サービスにリクエストを送信して応答を受けた状態を意味します。 WhaTapのアプリケーションモニタリングは、トランザクションが処理される過程をリアルタイムで確認できるサービスを提供します。

### 進行中のトランザクション

「進行中のトランザクション」を通じて、通常8秒以上の遅延を引き起こす問題、広範囲に現れるわけではなく、一部のトランザクションでのみ発生する問題を特定することができます。次の画面の一番上に位置する**_スピードメーター_**ウィジェットでは、現在進行中のトランザクション（中央領域）と終了したトランザクション（右領域）の状況全体を確認することができます。全体の状況の中で進行中のトランザクションをエージェント別に分けて表したのが**_アクティブトランザクション_**ウィジェットです。進行中のトランザクションの状態を分けて表したのが**_アクティブステータス_**ウィジェットです。

![](/img/best-p/apm-dashboard-tx-01.png)

トランザクションによって確認できるトラブルの現状は、まず応答時間を通じて照会できます。 また、進行中のトランザクションが終了しない場合は、これもトラブルとして認識する必要があります。 WhaTapは、進行中の状態の時間に応じて区間を分けて表示します。 青色は応答時間が正常なトランザクション、橙色は応答時間が8秒程度の遅いトランザクション、赤色は応答時間が通常の2倍以上に遅いトランザクションを意味します。 これにより、ユーザーは直感的に最も早くトラブルを認識できます。

**_アクティブトランザクション_**ウィジェットでは、遅延が発生する状況をエージェント別に確認できます。赤色の領域が各エージェントごとに分散されている場合は、遅延を発生させる要素をエージェントがインストールされたアプリケーションごとに確認する必要があります。逆に、赤色の領域が1つのエージェントでのみ発生する場合は、そのアプリケーションサーバーのみを確認できます。これにより、トラブルの原因が発生した場所をすぐに確認できます。 

外部の要素は**_アクティブステータス_**ウィジェットで確認できます。**_METHOD_**はその他の事項で正常トランザクションとみなします。その他の4つの状態値からトラブル原因を特定できます。外部接続に関する項目は、**_HTTPC_**、**_SQL_**の数値です。**_HTTPC_**の数値が上がるほど外部に接続されたサーバーとの応答が正しく行われないと見なければなりません。Databaseサーバーとの接続が正しくない場合は、**_SQL_**の数値が上がります。

アプリケーションサーバーで最も代表的なトラブルの1つは、DB接続プールに関するものです。DB接続プールの数が不足していると、新しい接続リクエストが発生するたびに遅延が発生し、パフォーマンストラブルの原因となります。この場合、 **_アクティブステータス _**ウィジェットの **_DBC _**数値が増加します。

**_SOCKET_**は外部システムとのTCP接続の試みを意味します。同様に、**_SOCKET_**の数値が持続的に増加するということは外部システムとのつながりがなく、トラブルが発生している可能性が高いです。

進行中のトランザクションに問題が発生した場合は、**_アクティブトランザクション_**ウィジェットのチャートをクリックしてスタックを確認することができます。**_アクティブトランザクション_**ウィジェットでトラブルが発生した領域のエージェントをクリックすると、そのエージェントの**_アクティブトランザクション_**ウィンドウが表示されます。このウィンドウは、進行中のトランザクションを一覧化して表現します。この一覧で**_トランザクション（URL）_**または**_SQL／HTPC（ms）_**項目が同一に出力されたものがあるか確認してください。一次的に発生するトラブルの原因が同じ現象なのか、それ以外に他の問題が発生したのか確認できます。

![](/img/best-p/apm-dashboard-activetx.png)

進行中のトランザクションの一覧で項目をクリックすると、そのトランザクションのスタックを確認できます。このスタック情報からトラブルの原因を分析できます。

### 終了したトランザクション

終了した個々のトランザクションを分布図として確認できるのがヒートマップウィジェットです。ヒートマップウィジェットでは、本来1秒かかるはずのトランザクションが予想よりも2秒程度かかる場合、つまり応答時間が2倍以上かかるトランザクションを見つけ、トラブル原因を分析します。

![](/img/best-p/apm-dashboard-hitmap.png)

ウィジェット右上の![上方向アイコン](/img/up-arrow.svg)または![下方向アイコン](/img/down-arrow.svg)ボタンを押してチャートを拡大または縮小することができます。チャート領域をマウスでドラッグすると、**_ヒートマップトランザクション_**ページに移動します。 

![](/img/best-p/apm-dashbard-hitmap-tx.png)

**_ヒートマップトランザクション_**ページでは、ユーザーがドラッグしたチャート領域のトランザクション情報を**_TXトレース_**テーブルに一覧表示されます。それぞれの項目をクリックすると、当該トランザクションの**_統計_**情報ウィンドウが表示されます。**_統計_**ウィンドウでどのようなプロセスを処理しながら遅くなったのかを段階別に確認することができます。

![](/img/best-p/apm-dashboard-tx-stats.png)

ユーザーからのリクエストがサーバーに到着してから、サーバーでロジックを実行して結果を表示するまで、多くのメソッドが実行されます。ここでどのメソッドを追跡すれば遅延している箇所を確認できるでしょうか？WhaTapは、複数のユーザーのリクエストを基本的に10秒間隔でスナップショットとして保存します。スナップショットに保存されたスタック情報をトランザクションに含めます。この場合のスタック情報を**_アクティブスタック_**（Active Stack）と定義します。

![](/img/best-p/apm-dashboard-active-stack.png)

スタックを集めて累積された量を基準に一覧化して確認できる機能が**_分析_** >**_スタック_**です。リソースと関連付けられていない内部ロジックでの遅延メソッド区間を統計的に見つけることができます。 

![](/img/best-p/apm-dashboard-top-stack.png)

## ユーザーおよびサービス、リソース分析

ユーザーとサービス、リソース間の相関関係を分析してAPチューニングを進めるには、ユーザー数に応じたTPS、応答時間、CPU使用率を確認する必要があります。

![](/img/best-p/apm-dashboard-user-service-resource.png)

**Transaction Per Second**（TPS、以下TPS）は、毎秒トランザクションを処理した量を意味します。ユーザーが増加するにつれて、TPSは次のようにグラフが描かれます。

![](/img/best-p/tps_example_02.png)

サービスにユーザーが増え続けると、ある瞬間からTPSはこれ以上増加しない状況が発生します。このように増加しない地点を**最大臨界使用点（Saturation Point）**といいます。上記のグラフのようなサービスが理想的な状況です。きちんとチューニングされていないサービスは、かえってTPSが落ちる現象が発生します。

次のグラフを参照してください。 TPSがこれ以上増加しない状態でユーザーが増えれば、応答時間はユーザーに比例して長くなります。

![](/img/best-p/response_time_example_01.png)

CPU使用率は、ユーザーが増加するにつれて次のようなグラフが描かれます。

![](/img/best-p/apm-dashboard-cpu-usage.png)

TPSの最大値はわかりにくいですが、CPUの最大値は100%です。しかし、CPUの使用率が100%または100%に近づいても、CPUの使用率だけではリソースが不足しているかどうかを判断するのは困難です。サービスのロジックに問題があり、CPU使用率が高くなる可能性もあるからです。ですから、上記の3つのグラフを直観的に把握し、比較して判断することが重要です。 

TPSはパフォーマンスの目安です。つまり、最大TPSはシステムの最大パフォーマンスを意味します。最適なチューニングは、最大TPS値を増やすことです。 

応答時間は、ユーザー数が増えるにつれて比例して増加するため、チューニングの指標とすることは困難です。ただし、応答時間を緩やかなグラフにすることが重要です。最大TPSを増やすには、応答時間のグラフを緩やかにする必要があります。それでチューニングの対象は応答時間です。個別URL、つまりトランザクションの応答時間を把握して分析することが必要です。**_ヒートマップ_**を利用すると、トランザクションの応答時間を分析し、遅くなる区間を見つけて原因を把握することができます。

上記の概念を熟知した状態で、**_アプリケーションダッシュボード_**の**_TPS_**ウィジェットと**_本日ユーザー_**または**_同時接続ユーザー_**ウィジェットを確認ください。ユーザー数が増える中でTPS数値が減ると、サーバーにトラフィックが増加するという意味です。このような場合、Scale-Outを通じてサーバーリソースを増設したり、トラフィックを制御してTPS数値を一定に維持することをお勧めします。

![](/img/best-p/apm-dashboard-best-practice.png)

Scale-Outを行う場合は、WhaTapのエージェントを追加してモニタリングを同時に行えるように措置する必要があります。Traffic制御が必要な場合は、WhaTapのエージェント設定を通じて進めることができます。アプリケーションの最大同時処理数を制限するスロットリング機能をアクティブ化できます。詳細な設定方法については、[次の文書](https://docs.whatap.io/java/agent-load-amount)を参照してください。

その他、次のグラフのようにユーザーは増加しますが、TPS数値が最大に上がらないまま一定に維持される場合、2つの状況を考慮しなければなりません。グラフ**Response#1**のように応答時間が継続的に上がる場合は、サービスロジックに問題がある可能性があります。逆に、グラフ**Response#2**のように応答時間も一定の数値を維持する場合、ユーザのリクエストをサーバが受信できない状況でネットワーク状態を確認する必要があります。

![](/img/best-p/tps-user-net-error.png)

その他、ウェブアプリケーションの顧客満足度を測定する**_Apdex_**ウィジェット、**_ヒープメモリ_**ウィジェットを確認することができます。 

**Application Performance Index(Apdex)**はアプリケーションのパフォーマンス指標です。 

![](/img/best-p/apm-dashbard-apdex.png)

ユーザー満足度に対する指標として活用でき、0~1の間の値を持ち、0~0.7は**_Poor_**(<span class='vslow'>赤色</span>)、 0.7~0.85は**_Fair_**(<span class='slow'>橙色</span>), 0.85~0.95は**_Good_**(<span class='api'>緑色</span>), 0.95~1は**_Excellent_**(<span class='normal'>青色</span>)の領域で表示します。Apdex指標とカラー領域を通じてアプリケーションの応答速度がユーザーに満足できる水準であるかを確認できます。Apdex指標の詳細は[次の文書](https://docs.whatap.io/java/agent-apdex)を参照してください。

**_ヒープメモリー_**（Heap Memory）ウィジェットは、各サーバー当たり使用可能な最大メモリーと現在使用中のメモリーを表現します。

![](/img/best-p/apm-dashbard-heap-memory.png)

Heap使用量が足りない場合、GCが頻繁に発生し、CPUを過度に占有することになります。正常なHeap使用量パターンはGCによって上下を繰り返します。ヒープメモリチャート分析の詳細については、次のリンクを参照してください。

-   [月刊WhaTap：モニタリングに注目すべき指標](https://www.whatap.io/ko/blog/94/)
-   [Javaヒープメモリーチャートの分析：Ch.1ヒープチャート観察](https://youtu.be/FcWfVrETWh4)
-   [JAVAヒープメモリーチャートの分析：Ch.2 メモリリーク、そしてヒープダンプの分析](https://youtu.be/t2q5z4HHNfs)

統合ダッシュボードを提供する可視性の高いモニタリングサービス。WhaTapと共にモニタリング業務の効率を高めてみてください。
