ホーム画面 > プロジェクト選択 > **_アラート通知_** > **_イベント設定_** >**メトリクス**タブ選択

## メトリクスイベントとは

メトリクスイベントは、基本イベント(アプリケーションイベント、サーバーイベントなど)より具体的で複雑なイベントを設定するために使用します。プロジェクトがリアルタイムで収集中のメトリクスデータに基づいてイベントを設定できます。使用状況に応じて、2つの設定方法のいずれかを選択してイベントを設定できます。

-   メトリクスイベント
-   複合メトリクスイベント

<Xclude product='npm'>

:::note

メトリクスの詳細については、[次の文書](metrics-intro)を参照してください。

:::

</Xclude>

<InDoc product='npm'>

:::note

メトリクスの詳細については、[次の文書](../metrics/common-metrics-intro)を参照ください。

:::

</InDoc>

## メトリクスイベント

**_アラート通知_** > **_イベント設定_**メニューから画面の上にある**_メトリクス_**を選択します。画面の右上にある **_+イベント追加_**を選択します。**_メトリクスイベント_**ウィンドウが表示されます。

![メトリクスイベント](/img/set-events-metrics.png)

### 基本情報を入力

-   **_イベント名_** ：追加するイベント名を入力してください。

-   **_イベントのアクティブ化_**：イベントのアクティブ化の有無を選択します。

-   **_テンプレート_**：作成したテンプレートを選択して、すばやく簡単にイベントを設定できます。テンプレートを使用しない場合は、**_使用しない_**を選択します。

-   **_カテゴリ_**：メトリクス データを区切る単位です。メトリクスイベント設定時の必須のオプションの値です。

    ![メトリクスイベント - カテゴリ](/img/set-event-select-category.png)

    -   **_カテゴリ_**選択オプションには、![指示線1](/img/number-01.png) **_名前_**と![指示線2](/img/number-02.png)データ収集間隔、![指示線3](/img/number-03.png) **_キー_**情報を表示します。イベント設定時に、そのカテゴリのキー値を使用します。

    -   **_カテゴリ_**は、3時間以内にプロジェクトによって収集されたメトリクスデータを検索し、一覧に表示します。**_カテゴリ_**選択オプションに収集間隔が表示されない場合は、**_手動で入力する_**オプションを選択して、カテゴリキーを入力します。

-   **_レベル_**

    -   イベント発生時の警告レベルを示します。<span class='vslow'>Critical</span>, <span class='slow'>Warning</span>、<span style={{color:'#757575'}}>Info</span>レベルに分けます。<span class='vslow'>Critical</span>、<span class='slow'>Warning</span>レベル設定時**_イベントの状態が解決すると、追加通知_**の選択オプションが有効になります。

    -   **_イベントの状態が解決した場合の追加通知_**：イベント項目中に発生したイベントの状態が解決した場合、追加の通知を選択できます。トグルボタンを選択して、機能をオンまたは、オフにすることができます。

-   **_メッセージ_**

    -   イベント発生時に出力する通知メッセージを入力します。`${タグまたはフィールドキー}` を入力してメッセージに変数を適用できます。変数に入力するキーは、選択したメトリック データ**_カテゴリ_**に含まれる値である必要があります。
    -   ![時間アイコン](/img/ico-timing.svg)ボタンをクリックすると、以前に入力したメッセージの履歴を確認できます。
    -   **_受信テスト_**は、**_イベント名_**、**_カテゴリ_**、**_レベル_**、**_メッセージ_**の情報に基づいて通知を発生させることでメッセージをチェックする機能です。

-   **_イベント発生条件_**

    ![イベント発生条件](/img/set-event-condition.png)

    ![指示線1](/img/number-01.png)フィールド、![指示線2](/img/number-02.png)演算子の選択、![指示線3](/img/number-03.png)しきい値を入力して、イベントが発生する条件を設定します。

-   **_イベント対象フィルタリング_**

    ![イベント対象フィルタリング](/img/set-event-filtering.png)

    ![指示線1](/img/number-01.png)タグ、![指示線2](/img/number-02.png)演算子の選択、![指示線3](/img/number-03.png)フィルタリング値を入力して、ターゲットをフィルタリングします。入力値が見つからない場合は、全体エージェントにアラート通知を送信します。

:::note

-   **_イベント発生条件_**と**_イベント対象フィルタリング_**で使用できる基本文法と演算子の一覧は、[次の文書](#condition-guide)を参照してください。

-   **_イベント発生条件_**と**_イベント対象フィルタリング_**オプションは、**_選択入力_**または**_直接入力_**モードを選択できます。

-   イベント設定が保存された後、オプション値は**_直接入力_**モードで管理します。その後、**_選択入力_**モードに切り替えると、オプション値が初期化される場合があります。

:::

### **_イベント受信設定_**

![イベント受信設定](/img/set-event-receive.png)

-   **_発生回数_**：選択した時間内に**_イベント発生条件_**で設定したイベントが入力回数と同じ回数が発生した場合、アラート通知が送信されます。

    :::note

    -   選択時間を**_使用しない_**に設定すると、入力した回数だけ連続して発生通知が送信されます。
    -   **_イベントの状態が解決された場合、追加通知_**オプションを有効にして、選択時間は**_使用しない_**を選択することをお勧めします。
    -   **_カテゴリ_**オプションで選択した項目のログ収集の周期は5秒です。

    :::

-   **_イベント発生の一時停止_**：過剰なアラート通知を発生しないようにするオプションです。最初のアラート通知から選択した時間にアラート通知を送信されません。 また、**_イベント履歴_**メニューには記録されません。

-   **_関連カテゴリ_**：関連カテゴリを最大5つまで設定し、通知を閲覧するときに参照します。

-   **_イベント受信タグ_**：イベント受信タグを選択すると、そのタグを持つプロジェクトメンバーと3rd-partyプラグインに通知を送信できます。イベント受信タグを選択しない場合は、プロジェクトの全体メンバーにアラート通知を送信します。

    :::note

    **_アラート通知_** > **_イベント受信設定_**メニューでプロジェクトメンバーと3rd-partyプラグインにタグを設定できます。

    :::

### **_通知ルールテスト_**

![アラート通知テスト](/img/set-event-test.png)

選択した時間に設定したイベント条件を実行し、アラート通知の件数を確認できます。実行ボタンを選択すると、通知発生の件数情報が表示され、イベント発生条件で選択したフィールドとしきい値がチャートに表示します。

## 複合メトリクスイベント

**_複合メトリクスイベント_**を利用するには、次の概念を理解する必要があります。

<Xclude product='npm'>

-   [メトリクスとは](metrics-intro)

</Xclude>

<InDoc product='npm'>

-   [メトリクスとは](../metrics/common-metrics-intro)

</InDoc>

-   [MXQL](../mxql/mxql-overview)

**_複合メトリクスイベント_**は、メトリクスデータに対するより複雑なルールを使用してイベントを生成し、アラート通知を送信します。複合メトリクスは、次のような状況で効果的に使用できます。

-   複数のエージェントから受信したデータに対して総合的にイベント判定を行う必要がある場合
-   過去のデータと現在のデータを比較して、イベント判定を行う必要がある場合

メトリクスイベントは、エージェントからメトリクスを受信するたびにイベント判定を行います。一方、複合メトリクスイベントは、各エージェントから収集されたメトリクスをデータベースに保存します。それから再度イベント判定を行います。これらの特性により複数のエージェントからのデータを集計したり、履歴データを活用することができます。ただし、**MXQL**と呼ばれるWhaTap独自のデータ言語を使用するという参入障壁があります。そのため、ユーザーが基礎的なレベルの**MXQL**を理解するだけで効果的にイベントを設定できるようにイベントテンプレートを提供します。MXQLのネイティブユーザーは、イベント対象のフィルタリングとイベント条件のクエリのみを修正することでイベントを適用することができます。

1.  **_アラート通知_** > **_イベント設定_**メニューから画面の上にある**_メトリクス_**を選択してください。 

2.  **_複合メトリクス_**セクションの右側にある**_+イベント追加_**を選択してください。 

3.  **_複合メトリクス_**ウィンドウが表示されたら、**_チャートで生成_**を選択してください。

イベント設定ウィンドウが表示されます。 

![複合メトリクスイベント設定](/img/set-event-cmetric.png)

:::note

複合メトリクスイベントを設定するには、**イベント設定**権限が必要です。

:::

### **_イベントデータ照会_**

**_複合メトリクスイベント_**は、メトリクスデータのクエリ言語である**MXQL**に基づいてイベント条件を生成します。**_チャートを生成する_**機能は、**MXQL**をオートコンプリートするためのコンボボックス機能を提供します。イベントデータを参照してチャートを構成し、イベント発行条件を直接入力するためのテンプレートです。**_ウィジェット_**または**_テキスト_**オプションを選択してイベントを設定してください。

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
<TabItem value='widget' label='ウィジェット'>

時系列チャートを設定するオプションにより、イベント設定時に使用する**MXQL**をオートコンプリートさせることができます。

![イベントデータ参照](/img/set-event-data-view.png)

-   **_フィルター_**：イベント条件の対象を選択します。![指示線1](/img/number-01.png)演算式、![指示線2](/img/number-02.png)タグ、![指示線3](/img/number-03.png)フィルタリング値を入力して、フィルタリング条件を作成します。

    ![フィルター](/img/set-event-cmetric-filter.png)

-   **_グループ化_**：グループ化されたメトリクスデータを選択します。複数を選択できます。

-   **_時間単位_**：グループ化されたデータを分割する時間基準を設定します。**_秒_**、**_分_**、**_時間_**で選択して設定することができます。

-   **_フィールド_**：イベント発行条件に使用するフィールドを選択します。複数選択が可能です。

</TabItem>
<TabItem value='text' label='テキスト'>

**MXQL**を平文のまま修正できる編集ウィンドウが表示されます。

![メトリクスイベント - テキスト](/img/set-event-metrics-text.png)

</TabItem>
</Tabs>

### **_通知_**

アラート通知設定の基本情報を入力します。

-   **_イベントのアクティブ化_**：トグルボタンをクリックして、イベントをアクティブ化の有無を選択します。

-   **_レベル_**: <span class='vslow'>危険(Critical)</span>, <span class='slow'>警告(Warning)</span>, <span style={{color: '#757575'}}>情報</span>の中で一つのレベルを選択してください。

    **_イベントの状態が解決した場合の追加通知_**：イベント項目中に発生したイベントの状態が解決した場合、追加の通知を選択できます。トグルボタンを選択して、機能をオンまたは、オフにすることができます。

-   **_タイトル_**：アラート通知のタイトルを入力します。

-   **_メッセージ_**：イベント発生時に出力する通知メッセージを入力します。`${タグまたはフィールドキー}` を入力してメッセージに変数を適用できます。変数に入力するキーは、選択した複合メトリクスデータ**_カテゴリ_**に含まれる値である必要があります。

### **_イベント発行条件_**

アラート通知を送信する条件を入力します。

-   **_データ参照範囲_**: イベント条件に使用する**MXQL**のリアルタイムデータの参照範囲を設定します。イベント データの参照に含まれるフィールドのみ使用できます。

    複合メトリクスイベントは、DBに保存されているメトリクスを参照して使用します。したがって、最初にデータを検索する時間範囲を指定する必要があります。データ取得時間を5分で選択すると、過去5分間に収集されたデータが参照され、イベント発生条件を確認します。最近のデータに対して、イベントを設定する場合は短く、統計的にアクセスしたい場合は長く設定できます。実際の使用例については、[次の文書](#template)を参照してください。

-   **_条件_**：MXQLに反映するフィールドと演算ルール、しきい値を入力します。

### **_付加情報_**

アラート通知を受信するために追加オプションを設定します。

-   **_インターバル_**：選択した時間間隔で通知条件を確認します。

-   **_ミュート_**：過剰なアラート通知の発生を防ぐオプションです。最初のアラート通知から選択した時間にアラート通知は送信しません。また、**_イベント履歴_**メニューに記録されません。

-   **_イベント受信タグ_**：イベント受信タグを選択すると、そのタグを持つプロジェクトメンバーと3rd-partyプラグインに通知を送信できます。イベント受信タグを選択しない場合は、プロジェクトの全体メンバーにアラート通知を送信します。

    :::note

    **_アラート通知_** > **_イベント受信設定_**メニューでプロジェクトメンバーと3rd-partyプラグインにタグを設定できます。

    :::

### **_イベントルールテスト_**

![イベントルールテスト](/img/set-event-cmetric-test.png)

選択した時間に設定したイベント条件を実行し、アラート通知の件数を確認できます。実行ボタンを選択すると、通知発生の件数情報が表示され、イベント発生条件で選択したフィールドとしきい値がチャートに表示します。

イベント設定に含まれるほとんどの内容は、**MXQL**を使用して指定されます。**MXQL**が正しく作成されているかシミュレーションできる機能を提供します。シミュレーション機能は、過去24時間のデータを参照してイベントを特定した後、表示されたメトリックの数と成功したメトリックの数を表示します。

## メトリクスイベントの修正と削除

1.  **_アラート通知_** > **_イベント設定_**メニューから移動した後**_メトリクス_**タブを選択してください。 

2.  イベント一覧から修正または削除する項目の右端の![編集アイコン](/img/ico-edit.svg)ボタンをクリックしてください。

3.  メトリクスまたは複合メトリクスのイベント設定ウィンドウが表示されたら、各オプションを修正して、**_保存_**ボタンを選択してください。

  選択したイベントを削除するには、イベント設定ウィンドウの右上の![削除アイコン](/img/ico-trash.svg) **_削除_**ボタンをクリックしてください。

## 発生条件、対象選択ガイド{#condition-guide}

メトリクスアラート通知でイベントの発生条件とイベント対象選択では同じ文法を使用します。ただし、イベントの生成条件は、タグ(Tag)のKeyを変数として使用し、イベント対象選択は、フィールド(Field)のKeyを変数として使用します。

### 基本文法

-   文字列をそのまま入力すると変数、バッククォート(' ')またはダブルクォート('' ")で囲むとtextとして認識します。

    ```java title='oid == "oid"'
    1. oid : 変数
    2. == : 関数
    3. "oid" : text
    ```

    ```java
    // onameがott-1235の場合

    // 正常な場合
    onname = 'ott-1235'またはonname = "ott-1235"

    // 異常な場合、通知は機能しません。
    onname = ott-1235
    ```

-   数字をそのまま入力すると、number、バッククォート(' ')またはダブルクォート('' '')で囲むとtextとして認識します。

    ```java title='oid == 123'
    1. oid : 変数
    2. == : 関数
    3. 123 : number
    ```

    ```java
    // oidが123の場合

    // 正常な場合
    oid = 123

    // 異常な場合、通知は機能しません。
    id == '123' または oid == '123'
    ```

### 使用可能な演算子の一覧

|   オペレーター       | 使い方                           | 説明                                                                                            |
| :------------: | ----------------------------- | --------------------------------------------------------------------------------------------- |
|    ==          | operand1 == operand2          | operand1とoperand2の値が同じであることを確認します。                                                            |
|    !=          | operand1 != operand2          | operand1とoperand2の値が異なることを確認します。                                                              |
| <span>></span> | operand1 > operand2           | operand1の値がoperand2の値より大きいことを確認します。                                                           |
|    > =         | operand1 >= operand2          | operand1の値がoperand2の値より大きいことを確認します。                                                           |
|    \<          | operand1 \< operand2          | operand1の値がoperand2の値より小さいことを確認します。                                                           |
|    \<=         | operand1 \<= operand2         | operand1の値がoperand2の値より小さいことを確認します。                                                           |
|    like        | operand1 like operand2        | operand1をKeyとして、Valueがoperand2で開始または終了していることを確認します。                                           |
|    &&          | expression1 && expression2    | expression1とexpression2の両方が`true`であることを確認します。                                                 |
|    and         | expression1 and expression2   | expression1とexpression2の両方が`true`であることを確認します。<br/>**&&**と同じ役割を実行する演算子です。                      |
|     ||         | expression1 || expression2    | expression1またはexpression2が`true`であることを確認します。                                                  |
|    or          | expression1 or expression2    | expression1またはexpression2が`true`であることを確認します。<br/>**||**と同じ役割を実行する演算子です。                       |

#### likeの使い方

`startsWith`関数と`endsWith`関数の機能を簡単に使用できるように、`like`オペレーターを追加しました。

-   `startsWith`の代わりに`like`演算子を使用

    ```java
    startsWith(Key, "Value")

    // like演算子
    Key like "Value*"
    ```

-   `endsWith`の代わりに`like`演算子を使用

    ```java
    endsWith(Key, "Value")

    // like演算子
    Key like "*Value"
    ```

-   `startsWith`と`endsWith`を同時に対応

    ```java
    Key like "*Value*"
    ```

-   文字列の途中で、\*を使用することができません。

    ```java
    // 対応文法
    Key like "tag*lue"
    ```

-   `like`演算子から\*が省略される場合は、==として動作します。

    ```java
    // 以下の2つの文章は同じ結果になります。
    Key like "Value"

    Key == "Value"
    ```

### 使用可能なメソッド一覧

| メソッド                      | 使い方                        | 説明                                                                      |
| ------------------------- | -------------------------- | ----------------------------------------------------------------------- |
| [startsWith](#startwith)  | startsWith(param1, param2) | param1をKeyとするValueがparam2で始まる場合は、`true`、反対の場合は、`false`                  |
| [endsWith](#endsWith)     | endsWith(param1, param2)   | param1をKeyとするValueがparam2で終わる場合、`true`、反対の場合は、`false`                   |
| [isNull](#isnull)         | isNull(param1)             | param1が`null`の場合は、`true`、反対の場合は、`false`                                 |
| [isNotNull](#isnotnull)   | isNotNull(param1)          | param1が`null`でない場合は、`true`、反対の場合は、`false`                               |
| [isEmpty](#isempty)       | isEmpty(param1)            | param1が`null`または`EmptyString("")`の場合は、`true`、反対の場合は、`false`             |
| [isNotEmpty](#isnotempty) | isNotEmpty(param1)         | param1が`null`でも、`EmptyString("")`でもない場合は、`true`、反対の場合は、`false`          |

#### startsWith{#startwith}

```java
startsWith(Key, "Value")
```

#### endsWith{#endswith}

```java
endsWith(Key, "Value")
```

#### isNull{#isnull}

```java
isNull(Key)
```

#### isNotNull{#isnotnull}

```java
isNotNull(Key)
```

#### isEmpty{#isempty}

```java
isEmpty(Key)
```

#### isNotEmpty{#isnotempty}

```java
isNotEmpty(Key)
```

## テンプレート{#template}

<Xclude product='browser,npm'>

![複合メトリクス - テンプレート](/img/set-event-cmetric-template.png)

-   複数のエージェントから受信したデータについて総合的にイベント判定を行う必要がある場合

    -   **_Inactive agents has been found._**
    -   **_Very slow active transactions detected._**

-   過去のデータと現在のデータを比較してイベント判定を行う必要がある場合 

    **_TPS has changed by more than 30% compared to the previous week._**

-   **_Inactive agents has been found._**

    -   プロジェクトに含まれるすべてのエージェントの中で、正常なエージェント数が6つ未満でイベントが発生すると、アラート通知を送信します。
    -   条件：`num_of_current_agents` \< 6

-   **_Very slow active transactions detected._**

    -   プロジェクトに含まれる特定の`okind`に属するエージェントから8秒以上かかるトランザクション数の合計が10個を超えるとアラート通知を送信します。
    -   条件：`very_slow_tx_cnt_m5_avg` > 10

-   **_TPS has changed by more than 30% compared to the previous week._**

    -   プロジェクトに含まれている特定の`okind`に属するエージェントのTPSが合計7日前と比較して30%以上変化すると、アラート通知を送信します。
    -   条件：`one_week_diff_abs` > `current_tps` \* 0.3

</Xclude>

<InDoc product='browser'>

**Browser**モニタリングでは、次のようにアラート通知テンプレートを提供します。 

#### メトリクスイベントテンプレート

**_アラート通知_** > **_イベント設定_** > **_メトリクス_**セクションで**_+イベント追加_**ボタンを選択してください。**_テンプレート_**から目的の項目を選択してください。

-   **_ページ読み込み時間の異常_**

    ページグループ(`${page_group}`)のページ読み込みに10秒以上かかる場合は、アラート通知を送信します。

-   **_ブラウザーのエラー回数の異常_**

    10件以上のブラウザーエラーが発生する場合は、アラート通知を送信します。

-   **_AJAXレスポンス時間異常_**

    AJAX Path(`${request_path}`)のAJAXレスポンス時間が30秒以上を超える場合は、アラート通知が送信されます。

#### 複合メトリクスのイベントテンプレート

**_アラート通知_** > **_イベント設定_** > **_複合メトリクス_**セクションで**_+イベント追加_**ボタンを選択してください。**_テンプレート_**から目的の項目を選択してください。

-   **_毎分ページの読み込み時間の異常_**

    ページグループ(`${page_group}`)の1分あたりの平均ページ読み込み時間が10秒を超える場合は、アラート通知を送信します。

-   **_1分間当たりのページの読み込み回数の異常_**

    ページグループ(`${page_group}`)のページ読み込み数が100件を超えて発生する場合は、アラート通知を送信します。

-   **_1分間あたりのルーター変更時間の異常_**

    ページグループ(`${page_group}`)の平均ルーター変更時間が10秒以上かかる場合は、ルーターはアラート通知を送信します。

-   **_毎分AJAXレスポンス時間の異常_**

    AJAX Path(`${request_path}`)の1分あたりの平均AJAXレスポンス時間が30秒を超える場合は、アラート通知を送信します。

-   **_毎分AJAXリクエスト数の異常_**

    ホスト(`${request_host}`)は、1分あたりのAJAXリクエスト数が1000件を超えて発生する場合は、アラート通知を送ります。

-   **_毎分AJAX失敗件数の異常_**

    AJAX Path(`${request_path}`)は、1分あたりのAJAXの失敗件数が100件を超えて発生する場合は、アラート通知を送ります。

-   **_毎分ブラウザーエラー数の異常_**

    ページグループ(`${page_group}`)の1分あたりのブラウザーエラー数が10件以上発生すると、アラート通知を送信します。

</InDoc>

<InDoc product='npm'>

次のようにアラート通知テンプレートを提供します。 

#### メトリクスイベントテンプレート

**_アラート通知_** > **_イベント設定_** > **_メトリクス_**セクションで**_+イベント追加_**ボタンを選択してください。**_テンプレート_**から目的の項目を選択してください。

-   **_Jitter > 30ms_**

    **jitter**が30/msを超えるとアラート通知を送信します。

-   **_Latency > 200ms_**

    **latency**が200/msを超えるとアラート通知を送信します。

-   **_Bps > 128 Mib/s_**

    **bps**が128Mib/sを超えるとアラート通知を送信します。

-   **_Pps > 50k/s_**

    **pps**が50k/sを超えるとアラート通知を送信します。

-   **_Sessions > 100_**

    セッション数が100を超えると、アラート通知を送信します。

</InDoc>
