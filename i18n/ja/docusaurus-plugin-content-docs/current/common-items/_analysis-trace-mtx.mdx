**マルチトランザクション**は、他のエージェントやプロジェクトに関連付けられたトランザクションを意味します。 WhaTapプロジェクトに登録されたアプリケーションサービス間の呼び出しを追跡するのが、**マルチトランザクション追跡**です。 

<InDoc product="java">

:::info

Javaエージェントは、3つのHTTPヘッダーキー値(`x-wtap-po`、`x-wtap-mst`、`x-wtap-sp1`)でマルチトランザクションを追跡します。 ゲートウェイを通過するHTTPトランザクションの連携追跡ができない場合は、HTTPヘッダー条件を確認します。

:::

</InDoc>

:::note

**マルチトランザクションの活性化**

マルチトランザクションを追跡するには、<Cmdname sid="management" className="uitext" /> &gt; <Cmdname sid="agent_configuration" className="uitext" />メニューで`mtrace_enabled`オプションを`true`に設定します。 エージェント設定の詳細については、[次の文書](set-agent#set-agent-service)を参照してください。

:::

## マルチトランザクションIDを確認する

<Cmdname sid="multi_server_transaction_trace" className="uitext" />メニューを利用するには、<b>MTID</b>(Multi Transaction ID)が必要です。 次の手順で<b>MTID</b>値が確認できます。

1. <Cmdname sid="analysis" className="uitext" /> &gt; <Cmdname sid="AA005" className="uitext" />メニューでチャート領域をドラッグします。

2. ドラッグしたチャート領域のトランザクション情報が以下のように下段の<Cmdname sid="trace_list" className="uitext" />一覧に表示されます。

   <ImgLang img='tx-trace-table.png' desc='mtrace_M' />

3. ![アイコン](/img/ic-s-mult-transation.svg)アイコンが表示されたトレースを選択すると<Cmdname sid="TTL06527" className="uitext" />画面が表示されます。 

4. <Cmdname sid="TTL06125" className="uitext" />タブで<Cmdname sid="TTL06107" className="uitext" />値を確認できます。

   <ImgLang img='tx-trace-dt-up.png' desc='レコード概要' />

:::note

- トランザクションで外部呼び出しをする場合でも、同じ<Cmdname sid="TTL06107" className="uitext" />が生成されます。 サービスごとにプロジェクトが分離されていても、最初に発行した<Cmdname sid="TTL06107" className="uitext" />を通じてアプリケーション間のすべてのトランザクションが確認できます。 <Cmdname sid="TTL06527" className="uitext" />画面でトランザクショントレースを詳細に分析する方法は、[次の文書](trs-profile#transaction-info)を参照にしてください。

- <Cmdname sid="TTL06527" className="uitext" />画面で<Cmdname sid="TTL06107" className="uitext" />を選択すると<Cmdname sid="TTL06377" className="uitext" />タブに移動します。 システム内またはシステム間で発生するさまざまな呼び出し関係を一目で確認でき、どのような問題が発生したかを識別して改善できるようにトランザクションとトレース情報を提供します。

:::

## マルチトランザクション追跡機能を利用する

1. <Cmdname sid="analysis" className="uitext" /> &gt; <Cmdname sid="multi_server_transaction_trace" className="uitext" />メニューに移動します。

2. <Cmdname sid="TTL06527" className="uitext" />画面で確認した<b>MTID</b>値を<Cmdname sid="search_mtid_or_custid" className="uitext" />項目に入力します。

   <ImgLang img='trace-mtx-mtid.png' desc='MTID' />

3. 照会する日付とプロジェクトを選択します。

4. 画面の下の<Cmdname sid="apply" className="uitext" />ボタンを選択します。

右の<Cmdname sid="BTN07120" className="uitext" />タブに、各トランザクションの呼び出し関係を把握できるダイアグラムが表示されます。

<ImgLang img='trace-mtx-mtid-chart.png' desc='マルチTX追跡' />

:::note

画面下段の<Cmdname sid="apply" className="uitext" />ボタンは、次の状況で無効になります。

- 以前の検索と同じフィルター値(MTID/CUSTID、日付、選択プロジェクト)を設定した場合

- フィルター値(MTID/CUSTID、日付、選択プロジェクト)を入力しなかった場合

:::

### <Cmdname sid="BTN07120" />

<Cmdname sid="BTN07120" className="uitext" />は、各トランザクションの呼び出し関係を迅速かつ明確にユーザーに提供します。 同じ<Cmdname sid="TTL06107" className="uitext" />を持つトランザクションサービスの個別実行時間が確認できます。 トランザクションノードの背景色で表示される所要時間(<LinkImage img="number-01.png" desc="number 1"/> <Cmdname sid="time_bar" className="uitext" />)からトランザクション間の呼び出し関係を確認できます。 <Cmdname sid="BTN07120" className="uitext" />ではマウスを利用して希望する位置に移動したり、スクロールして拡大または縮小できます。

![Chart](/img/trace-mtx-chart-timebar.png)

トランザクションノードを選択すると<Cmdname sid="TTL06527" className="uitext" />画面が追加で表示されます。 トランザクショントレースを使用して、トランザクションの詳細を確認できます。 <Cmdname sid="TTL06527" className="uitext" />画面でトランザクショントレースを詳細に分析する方法は、[次の文書](trs-profile#transaction-info)を参照にしてください。

- ***A***<Cmdname sid="small" className="uitext" /> / ***A***<Cmdname sid="big" className="uitext" />：ノードに表示されているフォントサイズを調整できます。

- <Cmdname sid="time_bar" className="uitext" />：各ノードに所要時間(<Cmdname sid="time_bar" className="uitext" />)を表示または非表示します。

- <Cmdname sid="application_name" className="uitext" />：各ノードにエージェント名(oname)を表示または非表示します。

- <Cmdname sid="project" className="uitext" />：各ノードにプロジェクト名を表示または非表示します。

- <Cmdname sid="database" className="uitext" />／<Cmdname sid="apply_external_remote" className="uitext" />／<Cmdname sid="apply_internal_remote" className="uitext" />：トランザクションで発生した他のデータベースコネクションの要求やHTTP Callの情報もチャートのノードで確認できます。

### <Cmdname sid="BTN07121" />

<Cmdname sid="BTN07121" className="uitext" />タブでは、マルチトランザクションに含まれている各トランザクションごとの情報をテーブル形式で確認できます。

<ImgLang img='trace-mtx-table.png' desc='表' />

各トランザクション項目を選択すると<Cmdname sid="BTN07120" className="uitext" />タブのノード選択と同様に、選択したトランザクションに対する<Cmdname sid="TTL06527" className="uitext" />画面が表示されます。 トランザクショントレースを使用して、トランザクションの詳細を確認できます。 <Cmdname sid="TTL06527" className="uitext" />画面でトランザクショントレースを詳細に分析する方法は、[次の文書](trs-profile#transaction-info)を参照にしてください。

![カラムアイコン](/img/ic-column.svg) <Cmdname sid="BTN06441" className="uitext" />：テーブルのカラムを編集できます。 

### <Cmdname sid="BTN06296" />

<Cmdname sid="BTN06296" className="uitext" />タブでは、各トランザクションとそれに属しているトレースの詳細を確認できます。 全体のトランザクション所要時間内での各下位トランザクションやトレースの開始および所要時間を可視化し、トランザクションの呼び出し関係をツリー形式で提供します。

<ImgLang img='trace-mtx-tree.png' desc='Tree' />

- ![一行表示アイコン](/img/ic-single-line.svg) <Cmdname sid="BTN06368" className="uitext" />：各区間ごとの実行情報に表示されたテキストを一行で表示し、ツリー形式を簡潔にまとめられます。

- ![複数行表示アイコン](/img/ic-multi-line.svg) <Cmdname sid="BTN06369" className="uitext" />：各区間ごとの実行情報に表示されたテキストを改行してすべて表示します。

- <Cmdname sid="BTN06327" className="uitext" />：最長の経路で移動できます。

- ![チャートアイコン](/img/ic-bar-chart.svg) <Cmdname sid="BTN06743" className="uitext" />：経過時間を棒チャートで表示します。

- ![時間アイコン](/img/ic-custom-time.svg) <Cmdname sid="BTN06744" className="uitext" />：各区間ごとのタイムスタンプ、ギャップ、経過時間をテキスト形式で表示します。

  - 8秒以上：<span class='etrs'>超過遅延</span>状態で<span class='etrs'>赤色</span>で表現します。

  - 3秒以上8秒未満：<span class='ov5ud10'>遅延</span>状態で<span class='ov5ud10'>オレンジ</span>で表現します。

  - 3秒未満：<span class='woer'>正常な</span>状態で<span class='woer'>青色</span>で表示します。

  :::note

  開始および所要時間の場合、トランザクション呼び出し環境によって生じる時差を上位トランザクションのトレースやマッピングで修正および表示することで、実際に収集された時間データとの差異が生じる可能性があります。

  :::

- ![非表示アイコン](/img/ic-eye-invisible.svg) <Cmdname sid="BTN06745" className="uitext" />：時間情報を非表示にします。

:::note

該当トレースの![統計アイコン](/img/ic-static.svg)ボタンまたは![ポップアップアイコン](/img/ic-popup.svg)ボタンを選択すると<Cmdname sid="remote_http_call_statistics" className="uitext" />、<Cmdname sid="activestack" className="uitext" />などの情報を確認できます。

:::

:::tip

SQL変数とHTTPクエリを照会するには、次のオプションをエージェント設定に追加します。

- SQLパラメータ情報の記録に関するエージェント設定は、[次の文書](agent-dbsql#profile-sql-param)を参照にしてください。

- HTTPパラメータ情報の記録に関するエージェント設定は、[次の文書](agent-transaction#profile_http_parameter)を参照にしてください。

```ini title='whatap.conf'
# SQLパラメータ照会オプション：オプションが適用されるとSQLパラメータを暗号化して収集します。
profile_sql_param_enabled=true 

# HTTPパラメータ照会オプション：オプションが適用されると、HTTPクエリパラメータを暗号化して収集します。
profile_http_parameter_enabled=true 
```

:::
