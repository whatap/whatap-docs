## AWS RDS Logに適用する

### AWS RDS Logモニタリングのための構成

![AWS RDS Log](/img/aws-rds-log-diagram.png)

AWSではRDSのモニタリング向けに様々な情報を提供しますが、これらの情報を確認するにはAWSコンソールから直接アクセスする必要があります。 しかし、WhaTapの**AWS RDS Log**はデータベースモニタリングの<Cmdname sid="side_log" className="uitext" />メニューからRDSのログとイベントを提供します。

WhaTapの**AWS RDS Log**は**AWS CloudFormation**を通じてインストールできます。 **AWS CloudFormation**についての詳細は[次のリンク](https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/Welcome.html)を参照してください。

### 権限確認

**AWS CloudFormation**を通じてWhaTapの**AWS RDS Log**をインストールするには、まず必要なIAM権限を確認してください。

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "cloudformation:CreateStack",
        "cloudformation:UpdateStack",
        "cloudformation:DeleteStack",
        "cloudformation:DescribeStacks",
        "cloudformation:DescribeStackEvents",
        "cloudformation:DescribeStackResource"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:CreateBucket",
        "s3:PutBucketVersioning",
        "s3:PutBucketPublicAccessBlock"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "lambda:CreateFunction",
        "lambda:UpdateFunctionCode",
        "lambda:UpdateFunctionConfiguration",
        "lambda:DeleteFunction",
        "lambda:AddPermission"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:CreateRole",
        "iam:GetRole",
        "iam:AttachRolePolicy"
      ],
      "Resource": "*"
    }
  ]
}
```

### インストールと設定

1. WhaTapが提供する**AWSCloudFormation**テンプレートを通じてインストールできます。 次のリンクへ移動してから、**パラメータ**セクションで以下の項目を入力します。

   <Link to='https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/quickcreate?stackName=WhaTapRDSLogAndEvent&templateURL=https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/agent/db/WhaTapRDSLogInstall.template' target='_blank' className='ext-link'>AWS CloudFormation Install</Link>

   - **Host**: WhaTap収集サーバーアドレス。WhaTapプロジェクトの<Cmdname sid="side_management" className="uitext" /> &gt; <Cmdname sid="side_agentInstall" className="uitext" />メニューで確認できます。 例) 13.124.11.223/13.209.172.35

   - **MemorySize**: WhaTapRDSLogのメモリサイズ。128MB \~ 10,240MB間の値を入力します。

   - **Pcode**: WhaTapプロジェクトのプロジェクトコード。<Cmdname sid="side_management" className="uitext" /> &gt; <Cmdname sid="side_projectManagement" className="uitext" />メニューで<Cmdname sid="pcode" className="uitext" />項目を確認してください。

   - **ProjectAccessKey**: WhaTapプロジェクトのアクセスキー。<Cmdname sid="side_management" className="uitext" /> &gt; <Cmdname sid="side_projectManagement" className="uitext" />メニューで<Cmdname sid="project_access_key" className="uitext" />項目を確認してください。

   - **TimeOut**: インストールされるWhaTapRDSLogが実行時に最大に維持できる時間です。

   - **UseReservedConcurrency**: WhaTap RDSの予約された同時性の使用有無です。

   - **ReservedConcurrency**: WhaTap RDSが予約された同時性を使用したときに、同時に実行できる最大インスタンスの数です。

2. ログモニタリングの詳細設定のために、次のリンクへ移動してください。

   <Link to='https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/quickcreate?stackName=WhatapRDSLogAndEventSettings&templateURL=https://s3.ap-northeast-2.amazonaws.com/repo.whatap.io/agent/db/WhaTapRDSLogSetting.template' target='_blank' className='ext-link'>AWS CloudFormation Setting</Link>

3. **パラメータ**セクションで以下の項目を順番に入力します。

   - **AwsRdsNames**: イベントを受信したいRDS Cluster、Instanceの名前一覧

     - 例) database-1、seoul-pro-db-01、seoul-pro-db-01-writer …

     - EventRuleを生成しないためには、`none`を入力します。

   - **RdsLogGroupName**(**1\~9**): ログを受信したいRDS CloudWatchLogGroup Name

     - 例) /aws/rds/seoul-pro-db-01

     - サブスクリプションフィルターを生成しない場合は、 `none `を入力します。

     :::note

     CloudWatchLogGroupは一度に最大9つまで接続できます。

     :::

   - **WhaTapRDSLogArn**: 前の段階で生成されたWhaTapRDSLogArn

     ![AWS CloudFormation output](/img/aws-rds-log-setting-output.png)

### 生成リソースを確認する

**AWS CloudFormation**からインストールされているリソースを確認します。

![AWS RDS Log](/img/aws-rds-log-resource.png)

- **S3** 

  - Bucket：WhaTap**AWS RDS Log**の実行ファイルを保存するAWS S3 Bucket (CopyZips)

- **Lambda**

  - Function 

    - CopyZipsFunction:WhaTap AWS S3 Bucketからユーザーの環境に実行ファイルを移すAWS Lambda Function

    - WhaTapRDSLog：AWS RDSのモニタリングのためのAWS Lambda Function

  - Permission

    - CWPermission: RDS CloudWatchLogGroupにLogが生成される時、WhaTapRDSLogを実行できるようにするPermission

    - EventBridgePermission: RDS Eventが発生した場合、EventBridgeでWhaTapRDSLogを実行できるようにするPermission

  - Role

    - CopyZipsFuntionがWhaTapのS3からファイルをインポートし、CopyZipsに入れるために必要なRole

    - WhaTapRDSLogがCloudWatchLogGroupにLogを残すために必要なRole

### フィルターとルールを確認する

![AWS CloudFormation](/img/aws-rds-log-check-resources.png)

- **WS CloudWatchLogGroup**

  SubscriptionFilter(1\~9): RDSの CloudWatch LogGroupに Logが入ってくるとWhatapRDSLogを実行させるフィルター

- **AWS EventBridge**

  Rule: AWSイベントで、RDSと関連したイベントが発生するとWhatapRDSLogを実行させるルール