### Segmentation fault、Sig bus エラー

PHP モニタリングを適用した後にサービスでエラーが発生した場合、Apache または PHP-FPM のエラーログを確認してください。

エラーログの中に `segmentation fault`、`sig bus` といったメッセージが含まれていないか確認します。  
これらのエラーは `kill child process`、`exit child`、`exit process` などのメッセージと一緒に表示されることがあります。

このエラーが発生する場合、PHP 拡張モジュール *whatap.so* が衝突している可能性があります。  
PHP 拡張モジュール *whatap.so* を無効化し、Apache または PHP-FPM を再起動してください。

サービスに影響を与えない環境で、Apache と PHP-FPM に `Core dump` の設定を追加し、再度 *whatap.so* をロードしてください。  
その後エラーが発生すると *dump* ファイルが生成されます。  
生成された *dump* ファイルを gdb で解析し、原因を特定してください。

---

#### モジュール無効化およびログ確認

まずモジュールを無効化し、エラーログを確認します。

---

##### Windows

**無効化テスト**
```cmd
REM php_whatap.dll を一時的に無効化
ren "C:\PHP\conf.d\whatap.ini" "whatap.ini.disabled"

REM Web サーバー再起動
net stop Apache2.4 && net start Apache2.4
```

**エラーログ確認**

* **Apache**
```cmd
type "C:\Apache24\logs\error.log"
```

* **IIS**
```cmd
REM イベントビューアを確認
eventvwr.msc
→ Windows ログ → アプリケーション
```

---

#### Core Dump 設定

1. *dump* ファイルを保存するディレクトリの権限を設定：

```bash
chmod 0777 /home/httpd-core
```

2. システム設定を適用：

```bash
ulimit -c unlimited
sysctl fs.suid_dumpable=2
sysctl kernel.core_uses_pid=0
sysctl kernel.core_pattern='| /home/httpd-core/core-%e.%p'
```

---

#### Apache

1. Apache 設定ファイルに CoreDumpDirectory を追加：

```bash
vi /etc/httpd/conf/httpd.conf

CoreDumpDirectory /home/httpd-core
```

2. Apache を再起動して設定を反映。

3. エラーが発生すると *dump* ファイルが生成されます。  
   gdb を使って解析し、`bt full` コマンドで完全なスタック情報を確認します：

```bash
# gdb /usr/sbin/httpd /home/httpd-core/core-httpd.31832
...

> bt full
```

---

#### PHP-FPM

1. FPM 設定ファイルで `rlimit_core` を設定：

```bash
rlimit_core = unlimited
```

2. PHP-FPM を再起動。

3. エラー発生時、*dump* ファイルが生成されます。  
   gdb で解析し、`bt full` でスタックトレースを確認します：

```bash
# gdb /usr/sbin/php-fpm /home/httpd-core/core-php-fpm.31832
...

> bt full
```
