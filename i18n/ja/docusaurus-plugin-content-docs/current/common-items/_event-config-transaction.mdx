ホーム画面 &gt; プロジェクト選択 &gt; ![アイコン](/img/ic-sitemap.svg) <Cmdname sid="sitemap" className="uitext" /> &gt; <Cmdname sid="side_event" className="uitext" /> &gt; <Cmdname sid="side_eventSetting" className="uitext" /> <code class="newfunc">New</code> &gt; **トランザクションイベントタブ**

トランザクションイベントは、特定のURL、エラー、ステータスコードなどのパターンを組み合わせて、トランザクションを詳細にモニタリングできる機能です。 
アプリケーションで発生したトランザクションのうち、設定された条件を満たすとアラートが発生します。 
1分単位でトランザクションデータを分析し、条件を満たすトランザクション数がしきい値を超えた場合にアラートが送信されます。

<ImgLang img="metric-event-transaction.png" desc="Metrics Event Transaction" />

## イベント一覧

イベント一覧では、作成されたトランザクションイベントを確認および管理できます。

- **有効状態**: スイッチでイベントの有効・無効を設定します。 
- **イベントレベル**: 危険（<span className="vslow">Critical</span>）、警告（<span className="slow">Warning</span>）、正常（<span className="info">Info</span>） 
- **検索機能**: イベント名、受信者、対象パターンを基準に検索できます。 
- **カラムサイズ調整**: 各カラムの境界をドラッグして幅を調整します。

### 主なカラム

| 項目      | 説明                                     |
| ------- | -------------------------------------- |
| No      | イベントの番号                                |
| 有効状態    | イベントが有効かどうかを示します                       |
| 修正      | イベントを編集できるボタン                          |
| イベント名   | ユーザーが設定したイベント名                         |
| 条件タイプ   | イベント発生の条件タイプ（経過時間、エラー発生、パターンのみ）        |
| 集計基準    | トランザクション数を集計する基準                       |
| 対象パターン  | イベントが適用される包含/除外パターン（URL、ステータスコードなど）    |
| 発生回数    | アラート発生の基準となる回数                         |
| 一時停止    | アラート後、一定時間同じイベントを無視する時間                |
| イベント受信  | アラートを受信するユーザーまたはグループ                   |

## イベントの追加/編集

イベントを追加するには、イベント一覧テーブルの右上にある <Cmdname sid="add_notification" className="uitext" /> ボタンをクリックします。 イベントを追加または編集する際は、次の3つのセクションで条件を設定します。

### 1. イベント条件の定義

イベントの発生条件を設定するセクションです。

- **条件タイプ（必須）**

  - 経過時間：指定時間（ms）以上かかったトランザクション

  - エラー発生：エラーが発生したトランザクション

  - パターンのみ：指定されたパターンに一致するトランザクション

- **経過時間のしきい値**：条件タイプが「経過時間」の場合、ms単位で入力します  

- **集計基準（必須）**  

  - 合計
  - エージェント別  
  - URL別
  - 各エージェントのURL別
  - エラークラス別
  - 各エージェントのエラークラス別
  - コンテキスト別
  - 各エージェントのコンテキスト別

      :::note

    ```
      コンテキストが存在しない場合は集計されません。

      - エージェントオプション設定をしていない場合（`app_context_enabled=true`）
      - Web トランザクションではない場合
    ```

      :::

- **発生回数（必須）**：指定回数以上発生時にアラートを送信

- **一時停止（必須）**：アラート後、同一イベントが再発生した際に無視する時間（1分～1日）

- **イベント稼働時間**：特定の時間帯のみイベントが動作するように設定可能

### 2. イベント対象選択

トランザクションのフィルタリング用パターンを設定します。

**パターン設定方法**

- Enterキーで区切って複数のパターンを入力できます。
- ワイルドカード（\*）を使用してパターンを設定できます。
- 同じタイプのパターンは OR 条件、異なるタイプのパターンは AND 条件として適用されます。
- パターンを一切設定しない場合は、プロジェクト内の全トランザクションが対象となります。

:::tip 

**スラッシュ(`/`)とワイルドカード（`*`）の組み合わせに注意してください**

- `/api/*` : `/api` にはマッチしません。`/api/` の後にパスが必要です。（例: ✅ `/api/users`, ❌ `/api`）
- `/api*` : `/api` 自体にもマッチします。（例: ✅ `/api`, ✅ `/api/users`, ✅ `/apitest`）

:::

#### 一致パターン

指定した項目と一致するデータをフィルタリングします。 致パターンは適用後、**青いタグ**で表示されます。

- **コンテキスト**：アプリケーションコンテキストのパターン
- **URL**：トランザクションURLのパターン（例：/api/*、*/users/\*）
- **エラークラス**：エラークラス名のパターン（例：*Exception、*Error）
- **エラーメッセージ**：エラーメッセージ内容のパターン
- **ステータスコード**：HTTPステータスコードのパターン（例：4**、5**）

#### 除外パターン

指定した項目と一致するデータをフィルタリング対象から除外します。 除外パターンは適用後、**赤いタグ**で表示され、 
一致パターンと同じ形式を使用します。

#### パターンマッチングの例

**1. 完全一致**

```
パターン: "hello"
"hello"     → 一致
"Hello"     → 不一致（大文字と小文字を区別）
```

**2. プレフィックス一致**

```
パターン: "hello*"
"hello"       → 一致
"helloworld"  → 一致
"hi"          → 不一致
```

**3. サフィックス一致**

```
パターン: "*world"
"world"       → 一致
"helloworld"  → 一致
"hello"       → 不一致
```

**4. 部分一致パターン**

```
パターン: "*ell*"
"hello"       → 一致 (h'ell'o)
"excellent"   → 一致 (exc'ell'ent)
"welcome"     → 不一致 (ell が含まれていない)
```

**5. 複合パターン**

```
パターン: "hello*world"
"hellobeautifulworld"  → 一致

パターン: "hello*test*"
"hellomytestcase"      → 一致

パターン: "*test*world"
"mytestcaseworld"      → 一致
```

#### 実際の使用例

- URL パターン

  - `/api/*` : /api/で始まるすべてのURL

  - `*/users/*` : usersを含むすべてのURL

  - `/api/v1/users` : 完全に一致するURLのみ

- エラークラスパターン

  - `*Exception` : Exceptionで終わるすべてのエラー

  - `java.lang.*` : java.langで始まるすべてのクラス

  - `*Timeout*` : Timeoutを含むすべてのエラー

- ステータスコードパターン

  - `4**` : 400番台のすべてのステータスコード

  - `404` : 404ステータスコードのみ

  - `5*`：500番台のすべてのステータスコード

:::note

**パターンの制限事項**

- **必須文字列**: パターンにはワイルドカード（\*）以外に、少なくとも1文字以上を含める必要があります。 ワイルドカードのみではパターンを設定できません。
  - ❌ 不可: `***`, `**`
  - ✅ 可能: `a*`, `*a`, `*a*`, `/api*`

- **空文字列**: 空文字列や null 値はマッチしません。

- **連続するワイルドカード**: 連続した `**` は、単一の `*` として扱われます。

- **複雑なパターン**: `*` を3つ以上含むパターンはサポートされていません。

- **正規表現は非対応**: 文字クラス（`[a-z]`）、数量子（`+`, `?`）、グルーピング（`()`）などは使用できません。

- **大文字・小文字を区別**: すべてのパターンマッチは大文字・小文字を区別します。

- **エスケープ不可**: `*` 文字自体をマッチさせる方法はありません。

:::

### 3. 基本情報および通知設定

このセクションでは、イベントの基本情報と通知の受信方法を設定できます。

- **イベントの有効化**: イベントを有効または無効に設定します

- **イベント名**（必須）: イベントを識別できる明確な名前を入力します。

- **イベントレベル**（必須）

  - <span className="vslow">Critical</span>: 危険

  - <span className="slow">Warning</span>: 警告

  - <span className="info">Info</span>: 正常、情報

- **イベント受信**

  - **全体受信**: プロジェクトに所属するすべてのメンバーが通知を受信します。

  - **タグ指定受信**: 特定のタグを持つメンバーのみ通知を受信します。 このオプションを選択すると、**受信タグ**項目が表示されます。 

    - **受信タグ**: 「タグ指定受信」を選択した場合、**+ タグ追加**ボタンをクリックするとドロップダウンメニューが表示されます。

    - ドロップダウンメニューから通知を受信する既存のタグを選択するか、新しいタグを直接作成できます。

## イベント動作例

以下は、トランザクションイベントが実際に発生した例です：

### 設定条件

- URLパターン: /api/posts/\**, /delete/*, /\*test\*/
- エラークラスパターン: \*TimeoutException\*, \*NullPointerException
- ステータスコードパターン: 4\*\*
- 除外エラークラス: \*IOException
- 除外ステータスコード: 5\*\*
- 集計基準: エージェント別
- 発生回数: 2回
- 一時停止: 5分

### 発生したアラートメッセージ例

イベントメッセージのトランザクション情報には、条件に一致した最後のトランザクションの値が表示されます。 

```
(ignored count: 3)
[Per Agent] limit: 2, count: 3
[Condition]
url patterns: /api/posts/**, /delete/*, */test/*
error class patterns: *TimeoutException*, *NullPointerException
status patterns: 4**
exclude error class patterns: *IOException
exclude status patterns: 5**
[Transaction]
url: /api/posts/test/timeout
txid: 408093121470636540
status: 408
error class: java.util.concurrent.TimeoutException
```

### イベントメッセージの構成説明

- **(ignored count: n)**: 一時停止時間中に条件に一致したが、通知が発生しなかったトランザクションの件数です。 一時停止時間中に無視された件がない場合、この項目は表示されません。

- **集計情報**: 設定された集計方式に応じて異なる形式で表示されます。
  - **エージェント別**: `[Per Agent] limit: n, count: n`
  - **URL別**: `[Per Url] limit: n` の後に各URLと発生件数を列挙
  - **エラークラス別**: `[Per Error Class] limit: n` の後に各エラークラスと発生件数を列挙
  - **コンテキスト別**: `[Per Context] limit: n` の後に各コンテキストと発生件数を列挙
  - **各エージェントのURL別**: `[Per Agent & Url] limit: n` の後に各URLと発生件数を列挙
  - **各エージェントのエラークラス別**: `[Per Agent & Error Class] limit: n` の後に各エラークラスと発生件数を列挙
  - **エージェント別コンテキスト別**: `[Per Agent & Context] limit: n` の後に各コンテキストと発生件数を列挙
  - **全体**: `[Total] limit: n, count: n`

- **[Condition]**: イベント発生時点で設定されていた条件を表示します。 設定されたパターンのみが表示されます。
  - **context patterns**: コンテキスト一致パターン
  - **url patterns**: URL一致パターン
  - **error class patterns**: エラークラス一致パターン
  - **error message patterns**: エラーメッセージ一致パターン
  - **status patterns**: ステータスコード一致パターン
  - **exclude context patterns**: コンテキスト除外パターン
  - **exclude url patterns**: URL除外パターン
  - **exclude error class patterns**: エラークラス除外パターン
  - **exclude error message patterns**: エラーメッセージ除外パターン
  - **exclude status patterns**: ステータスコード除外パターン

- **[トランザクション]**：条件に一致した最後のトランザクションの詳細情報です。
  - **url**: トランザクションのURL  
  - **txid**: トランザクションの固有識別子  
  - **status**: HTTPレスポンスステータスコード（HTTPトランザクションでない場合は非表示）  
  - **error class**: エラークラス（エラークラスがない場合は非表示）  
  - **error message**: エラーメッセージ（エラーメッセージがない場合は非表示）  

イベントメッセージには、設定された条件と実際に発生したトランザクションの情報がすべて含まれており、どの条件によってアラートが発生したのかを明確に確認できます。

:::note

注意事項

- トランザクションイベントは1分単位で集計・処理されます。

- 条件タイプが「パターンのみ」の場合は、必ず1つ以上の一致または除外パターンを設定する必要があります。

- パターンのマッチングは大文字と小文字を区別します。

- アラートメッセージには、条件に一致した最後のトランザクションの詳細情報が含まれます。

:::

## 最新のエージェントバージョン {#support-agent-version}

トランザクションイベントには、以下の最新エージェントバージョンが必要です。  

<InDoc product="java,kubernetes">

- Java: バージョン 2.2.48 以上  

</InDoc>

<InDoc product="php,kubernetes">

- PHP: バージョン未定（最新バージョン以上の使用を推奨、別途お問い合わせください）  

</InDoc>

<InDoc product="golang,kubernetes">

- Go: バージョン未定（最新バージョン以上の使用を推奨、別途お問い合わせください）  

</InDoc>

<InDoc product="dotnet,kubernetes">

- .NET: バージョン 2.3.5 以上  

</InDoc>

<InDoc product="python,kubernetes">

- Python: バージョン 1.7.8 以上  

</InDoc>

<InDoc product="nodejs,kubernetes">

- Node.js: バージョン 0.5.21 以上

</InDoc>
