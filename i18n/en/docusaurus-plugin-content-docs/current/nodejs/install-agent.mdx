---
id: install-agent
title: Installation of the Node.js agent
description: The following explains how to install an agent on the application server in the Node.js environment.
tags:
  - Node.js
---

import TR from '@site/src/components/TR';

{@include: ../common-items/_agent-signup-guide.mdx}  

{@youtube: 5kwc_Xne5Ok}

To use the Node.js monitoring service, the monitoring agent must be installed on the monitored application. For installation, use NPM (Node Package Manager).

-   Install the WhaTap agent module in the active Node.js application directory.

-   Write the configuration of WhaTap agent (_whatap.conf_).

-   Run the Node.js service again.

{@include: ../getting-started/_create-project-v2.mdx}

{@include: ../getting-started/_accesskey-v2.mdx}

## Download agent

1.  Install the agent in the active Node.js application directory.

    ```bash
    $ npm install --save whatap
    ```

2.  Copy the _whatap.conf_ file in the _node_modules/whatap_ path and then paste it into the root path of the source code.

3.  Go to the [WhaTap Monitoring Service](https://service.whatap.io).

4.  Select the created project and then copy the following among the **_downloaded items from the agent_** in the **_Install guide_** section.

    ```ini title='Example'
    license={access key}
    whatap.server.host={collection server IP}
    ```

5.  Paste it into the _whatap.conf_ file.

The host (`whatap.server.host`) address is the server address in which the WhaTap proxy has been installed. You can use a forward slash (/) as the delimiter to enter all addresses of the servers where the proxy server is running among the WhaTap servers.

<details>
<summary>Node.js agent configuration file</summary>

The roles of each file that makes up the Node.js monitoring service are as follows:

-   _whatap.conf_: Sample of the agent configuration file. Copy the file and enter the access key.

-   _lib_: Agent and tracer program

-   _README.md_: Guide to the agent installation

-   _package.json_: Configuration file for the NPM module environment

-   _index.js_: Main export declaration file

</details>

## Using

Add the following code to the first line of the application's main module. In case of the express module, the file is _app.js_ for example.

```javascript title='Javascript'
var whatap = require('whatap').NodeAgent;
```

To use ECMAScript (ES), add the following code together.

```javascript title='ES'
import WhatapAgent from 'whatap';
WhatapAgent.NodeAgent;
```

See the following application example:

```javascript
var WhatapAgent = require('whatap').NodeAgent;
import http from 'http';
import setupApp from '../src/app';
let server = null;
const port = normalizePort(process.env.PORT || '3000');
```

:::note

Because the agent executable code needs to be run first after starting node.js, it must be placed before the first `import`.

:::

After installation, see [the following](install-check) to make sure there is no problem.

### Separating whatap.conf files for each environment

In the following cases, set the file names excluding .conf.

-   In case of separating the projects for each environment

-   In case the agent options are set differently

-   In case of starting by pm2 in Cluster mode

```javascript
process.env.WHATAP_CONF = 'whatapdev';
process.env.WHATAP_NAME = 'NodeAgent-{ip2}-{ip3}-{cluster}';
var WhatapAgent = require('whatap').NodeAgent;
```

:::note

The arguments that can be set by the `WHATAP_NAME` option are as follows.

-   **ipN**: ip0, ip1, ip2, ip3

-   **cluster**: Cluster ID

-   **pid**: Process ID

-   **hostname**: Host name

:::

### Using the agent group unit function

Agent group unit function includes group topology and integrated topology. Replace `{group identifier}` with agent group name in the following code.

```javascript
process.env.WHATAP_OKIND = '{group identifier}';
var WhatapAgent = require('whatap').NodeAgent;
```

## PaaS application environment

### Configuring the default environment variables

When installing the agent in the PaaS application, all settings must be configured in the source file (_app.js_). The _whatap.conf_ file cannot be used.

Set the access key (`WHATAP_LICENSE`) and collection server IP (`WHATAP_SERVER_HOST`) as environment variables.

```javascript title='app.js'
process.env.WHATAP_LICENSE={Access Key};
process.env.WHATAP_SERVER_HOST={Collection Server IP};
var whatap=require('whatap').NodeAgent;
...
```

### Options that can be configured as environment variables

Because you cannot use the _whatap.conf_ file, set the WhaTap agent options as environment variables in the source file.

```javascript title='app.js'
process.env.profile_http_header_enabled=false;
process.env.profile_http_parameter_enabled=false;

process.env.profile_basetime=500;

process.env.auto_oname_enabled=false;
process.env.auto_oname_prefix='nodejs';

process.env.mtrace_rate=0;
process.env.mtrace_spec='v1';
process.env.stat_mtrace_enabled=false;
process.env.stat_domain_enabled=false;
```

:::note

For more information about the options that can be set in Node.js, see [the following](set-agent).

:::

## Starting the monitoring

Once the application server has been restarted, the agent starts collecting data.
