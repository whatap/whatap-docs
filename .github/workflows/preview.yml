name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      name:
        description: "Deployment?"
        default: "WhaTap"

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Update submodules
        run: git submodule update --init

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # ⚡️ Docusaurus / Rspack 캐시 복원
      # 캐시 경로는 프로젝트/버전에 따라 다를 수 있지만 보편적으로 아래 두 곳을 씀
      - name: Restore build caches (Docusaurus/Rspack)
        uses: actions/cache@v4
        with:
          path: |
            .docusaurus
            node_modules/.cache/rspack
          # 사이트 구조/번들러 설정이 크게 바뀌면 캐시 무효화되도록 lockfile + 주요 설정 파일을 키에 반영
          key: docusaurus-${{ runner.os }}-${{ hashFiles('yarn.lock', 'docusaurus.config.*', 'sidebars.*') }}
          restore-keys: |
            docusaurus-${{ runner.os }}-

      - name: Build website
        env:
          NODE_OPTIONS: --max-old-space-size=12288
        run: yarn build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
