name: Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      locales:
        description: "ë¹Œë“œí•  ì–¸ì–´ (ko/en/ja/all)"
        default: "ko"
        required: false

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Update submodules
        run: git submodule update --init

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # âš¡ï¸ Docusaurus / Rspack ìºì‹œ ë³µì›
      - name: Restore build caches (Docusaurus/Rspack)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            .docusaurus
            node_modules/.cache/rspack
          key: docusaurus-${{ runner.os }}-node20-${{ github.workflow }}-${{ hashFiles('yarn.lock','docusaurus.config.*','sidebars.*') }}
          restore-keys: |
            docusaurus-${{ runner.os }}-node20-${{ github.workflow }}-

      # ðŸ”Ž ì–´ë–¤ ë¹Œë“œ ì»¤ë§¨ë“œë¥¼ ì“¸ì§€ ê²°ì •
      - name: Decide build command from input locales
        run: |
          LOCALES="${{ github.event.inputs.locales }}"
          # ìž…ë ¥ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 'ko' ì‚¬ìš© (ì•ˆì „ìž¥ì¹˜)
          LOCALES="${LOCALES:-ko}"
          echo "Input locales: '${LOCALES}'"

          if [ "$LOCALES" = "all" ]; then
            echo "BUILD_CMD=yarn build" >> $GITHUB_ENV
            echo "âœ… Building ALL locales"
          else
            echo "BUILD_CMD=yarn build --locale ${LOCALES}" >> $GITHUB_ENV
            echo "âœ… Building SINGLE locale: ${LOCALES}"
          fi

      - name: Inspect caches (optional)
        run: |
          echo "cache-hit: ${{ steps.cache.outputs.cache-hit }}"
          du -sh .docusaurus || true
          du -sh node_modules/.cache/rspack || true

      - name: Build website
        env:
          NODE_OPTIONS: --max-old-space-size=12288
        run: $BUILD_CMD

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com