"use strict";(self.webpackChunkwhatap_docs=self.webpackChunkwhatap_docs||[]).push([["7034"],{17789:function(e,n,t){t.r(n),t.d(n,{metadata:()=>i,default:()=>l,frontMatter:()=>r,contentTitle:()=>c,toc:()=>h,assets:()=>a});var i=JSON.parse('{"id":"best-practice-guides/about-apm-dbc","title":"DB connection delay and connection pool","description":"The following guides you to the DBC delay issue (one of application performance failures) and the connection pool.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/best-practice-guides/about-apm-dbc.mdx","sourceDirName":"best-practice-guides","slug":"/best-practice-guides/about-apm-dbc","permalink":"/whatap-docs/best-practice-guides/about-apm-dbc","draft":false,"unlisted":false,"editUrl":"undefined/docs/best-practice-guides/about-apm-dbc.mdx","tags":[],"version":"current","frontMatter":{"id":"about-apm-dbc","title":"DB connection delay and connection pool","description":"The following guides you to the DBC delay issue (one of application performance failures) and the connection pool.","keywords":["Application","Application Monitoring","APM","DBC","Performance failure"],"toc_max_heading_level":2,"displayed_sidebar":"learningSidebar","isTranslationMissing":false},"sidebar":"learningSidebar","previous":{"title":"\uBE0C\uB77C\uC6B0\uC800 \uBAA8\uB2C8\uD130\uB9C1","permalink":"/whatap-docs/best-practice-guides/using-browser-monitoring"},"next":{"title":"\uD799 \uBA54\uBAA8\uB9AC \uBA54\uD2B8\uB9AD\uC2A4","permalink":"/whatap-docs/best-practice-guides/about-apm-heap-memory"}}'),o=t(74848),s=t(84429);let r={id:"about-apm-dbc",title:"DB connection delay and connection pool",description:"The following guides you to the DBC delay issue (one of application performance failures) and the connection pool.",keywords:["Application","Application Monitoring","APM","DBC","Performance failure"],toc_max_heading_level:2,displayed_sidebar:"learningSidebar",isTranslationMissing:!1},c,a={},h=[{value:"Detecting the hitmap anomaly pattern",id:"detecting-the-hitmap-anomaly-pattern",level:2},{value:"Analysis on the transaction trace",id:"analysis-on-the-transaction-trace",level:2},{value:"Checking the DB connection pool",id:"checking-the-db-connection-pool",level:2},{value:"Adjusting the connection pool size",id:"adjusting-the-connection-pool-size",level:3},{value:"Reusing and optimizing the connections",id:"q12",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",section:"section",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{ImgLang:i}=n;return i||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("ImgLang",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["This document introduces the correlations between ",(0,o.jsx)(n.strong,{children:"DB connection delay"})," (DBC delay) that is one of application performance failures, and the ",(0,o.jsx)(n.strong,{children:"connection pool"})," from the monitoring perspective."]}),"\n",(0,o.jsxs)(n.p,{children:["First, assuming that the failure situation has been recognized through the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," widget on the dashboard, go to the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," menu under the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Analysis"})})," menu to specify the time to look at the before and after of the failure situation. Based on this, let's look at the process of inferring the cause of the failure through the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Trace information"})})," window and ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Metrics chart"})}),"."]}),"\n",(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Learning in advance"})}),(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Application dashboard"})})," \u2192 ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"HITMAP transaction"})})," \u2192 ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Trace information"})})," \u2192 ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Metrics chart"})})]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["If you have recognized the problem, check the past records to see before and after the problem situation. After checking the transaction overload pattern in the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap transaction"})})," chart, you can consider the cause of transaction delay as DB connection problem through the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"TX trace"})})," list."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"After searching for each section, let's look at the detailed execution history step by step through trace analysis. We can see that the DBC step took the most of the elapsed time."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Let's look at various metrics together through the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"metrics chart"})}),". By comparing the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB pool count"})})," and ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB active count"})})," charts, you can determine that the cause is the shortage of DB connection pool."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Depending on the operating environment, you can gradually adjust the connection pool size or configure the optimization settings to prevent water leak."}),"\n"]}),"\n"]})]}),"\n",(0,o.jsxs)(n.section,{className:"remark-sectionize-h2",children:[(0,o.jsx)(n.h2,{id:"detecting-the-hitmap-anomaly-pattern",children:"Detecting the hitmap anomaly pattern"}),(0,o.jsx)(i,{img:"best-p/apm-dbc-hitmap-hl.png",desc:"\uD788\uD2B8\uB9F5 \uC774\uC0C1 \uD328\uD134 \uAC10\uC9C0"}),(0,o.jsxs)(n.p,{children:["Speed is the key to recognizing failures and tracing their causes through primary analysis. WhaTap provides an intuitive view and the history search function to obtain additional information for root causes. If a sudden abnormality is detected as in the example in the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," widget on ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Application dashboard"})}),", what is the next step?"]}),(0,o.jsxs)(n.p,{children:["You can quickly perform the transaction trace analysis by dragging the problem section in the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," widget, or move to ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," under the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Analysis"})})," menu to expand the time range to look at before and after the problem situation."]}),(0,o.jsx)(i,{img:"best-p/apm-dbc-hitmap-hitmap-tx.png",desc:"\uD788\uD2B8\uB9F5 \uD2B8\uB79C\uC7AD\uC158 \uCC28\uD2B8 \uC774\uB3D9 sc"}),(0,o.jsxs)(n.p,{children:["Let's proceed with the latter route. The dashboard ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"hitmap"})})," widget is a distribution chart of transaction response times completed in the last 10 minutes. In other words, to check the past history for the last 10 minutes or more by specifying the time range, go to ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap"})})," under the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Analysis"})})," menu. You can move as shown in the example by selecting the ",(0,o.jsx)(n.img,{alt:"Right arrow icon",src:t(56962).A+"",width:"20",height:"20"})," arrow icon on the upper right of the widget."]}),(0,o.jsxs)(n.p,{children:["Through the time selector at the top of ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"HITMAP transaction"})}),", you can search for the past history by specifying the desired time range. To confirm abnormal patterns, we searched widely before and after the problem section and could identify an overload pattern with a high concentration of transactions with delayed responses."]}),(0,o.jsx)(i,{img:"best-p/apm-dbc-hitmap-drag.png",desc:"\uD788\uD2B8\uB9F5 \uB4DC\uB798\uADF8"}),(0,o.jsxs)(n.p,{children:["To find the cause of this sudden increase in response time and transaction overload, drag each problem section on the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Hitmap transaction"})})," chart to view the transaction trace list (",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"TX trace"})})," list)."]}),(0,o.jsx)(i,{img:"best-p/apm-dbc-hitmap-tr-list.png",desc:"\uD788\uD2B8\uB9F5 \uD2B8\uB79C\uC7AD\uC158 \uBAA9\uB85D"}),(0,o.jsxs)(n.p,{children:["Through the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"TX trace"})})," list, you can see that the ratio of ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB connect time"})})," to ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Elapsed time"})})," is great in many transactions. For example, in case of ",(0,o.jsx)(n.code,{children:"/api/system/test"})," URL, of the total ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"elapsed time"})})," of 25,057 ms, only the DB connection took 24,931 ms. In other words, we can assume that there is a problem primarily with the DB connection. Next, select the transaction and then look at the details in the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Transaction information"})})," window."]}),(0,o.jsxs)(n.admonition,{type:"note",children:[(0,o.jsx)(n.mdxAdmonitionTitle,{}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["The horizontal axis of the hitmap indicates the transaction end time, and the vertical axis the response time. You can view the response time delay section on the vertical axis up to 80 seconds by selecting the ",(0,o.jsx)(n.img,{alt:"Up arrow icon",src:t(55099).A+"",width:"16",height:"16"})," arrow icon on the hitmap."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["For more information about the analysis on hitmap patterns other than overload patterns, see ",(0,o.jsx)(n.a,{href:"about-apm-hitmap-class#about-hitmap-pattern-analysis",children:"the following"}),"."]}),"\n"]}),"\n"]})]})]}),"\n",(0,o.jsxs)(n.section,{className:"remark-sectionize-h2",children:[(0,o.jsx)(n.h2,{id:"analysis-on-the-transaction-trace",children:"Analysis on the transaction trace"}),(0,o.jsxs)(n.p,{children:["In the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Trace information"})})," window, you can see the transaction performance history by step. Through this transaction tracing, you can trace the causes of poor performance or errors in transactions. When viewing the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Trace analysis"})})," window, the information for you to look at first is the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"elapsed"})})," times for each step. This is because comparing the elapsed times allows you to quickly identify the cause of poor performance or errors."]}),(0,o.jsx)(i,{img:"best-p/apm-dbc-tx-tr.png",desc:"\uD2B8\uB79C\uC7AD\uC158 \uD2B8\uB808\uC774\uC2A4 \uBD84\uC11D sc"}),(0,o.jsxs)(n.p,{children:["Let's look at the detailed trace of the URL. The query execution time that connects the PostgreSQL DB while running ",(0,o.jsx)(n.code,{children:"/api/system/test"})," is between 1 ms and 6 ms. Accordingly, there is no critical problem. However, you can find that the waiting time for DB connection is significantly longer than the time, and the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB Connection"})})," step is the longest ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"elapsed"})})," time."]}),(0,o.jsx)(n.p,{children:"In other words, in this case, the transaction delay occurred due to the DB connection delay, as assumed earlier. What causes this DB connection delay?"})]}),"\n",(0,o.jsxs)(n.section,{className:"remark-sectionize-h2",children:[(0,o.jsx)(n.h2,{id:"checking-the-db-connection-pool",children:"Checking the DB connection pool"}),(0,o.jsxs)(n.p,{children:["One of the causes of ",(0,o.jsx)(n.strong,{children:"DB connection delay"})," is the ",(0,o.jsx)(n.strong,{children:"shortage of connection pool"}),". The connection pool size means the number of connections that can be made simultaneously. The database consumes lots of time while creating and ending connections based on the requests. The connection pool creates a specific number of connections in advance and makes the current connection pool reused when other requests occur. This can decrease the response time because creating connection is not required each time. The problem is that the number of pre-created connections is insufficient compared to the number of connections required by the application. In this case, a delay in DB connection is followed."]}),(0,o.jsxs)(n.p,{children:["To check the status of the DB connection pool, go to ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Metrics chart"})})," in the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Analysis"})})," menu. First, select ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Database"})})," from the list on the left of ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"Metrics chart"})}),", and then check the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB pool count"})})," and ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB active count"})})," charts."]}),(0,o.jsx)(i,{img:"best-p/apm-dbc-mcht.png",desc:"\uBA54\uD2B8\uB9AD\uC2A4 \uCC28\uD2B8"}),(0,o.jsxs)(n.p,{children:["As you can see in each chart, the maximum number of connections for ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB Pool"})})," is set to 20. If you look at the ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.em,{children:"DB active count"})})," chart, you can see that 20 pools are continuously occupied. If the requests that exceed the specified pool count are raised, a delay is followed until there is any remaining pool in the DB. When checking the resource status such as CPU and memory usage, there were no special happenings. In other words, in case of this project, the shortage in DB connection pool is considered as the root cause of DBC delay."]}),(0,o.jsxs)(n.p,{children:["What is required if the DB connection pool is insufficient? Of course, the solution may differ depending on the user environment. In this document, the required steps are briefly explained through ",(0,o.jsx)(n.strong,{children:"Connection pool resizing"})," and ",(0,o.jsx)(n.strong,{children:"Connection reuse and optimization"}),"."]})]}),"\n",(0,o.jsxs)(n.section,{className:"remark-sectionize-h3",children:[(0,o.jsx)(n.h3,{id:"adjusting-the-connection-pool-size",children:"Adjusting the connection pool size"}),(0,o.jsx)(n.p,{children:"First, you can use the method to adjust the maximum number of connections in the pool. Set the appropriate number of pools by gradually increasing pools and checking that the DB active count is kept within the maximum number of pools. However, if the pool count is set too large, it may adversely affect the application performance due to an excessive increase in resource consumption. After ensuring sufficient memory and capacity, adjust it depending on the operating environment."})]}),"\n",(0,o.jsxs)(n.section,{className:"remark-sectionize-h3",children:[(0,o.jsx)(n.h3,{id:"q12",children:"Reusing and optimizing the connections"}),(0,o.jsx)(n.p,{children:"Second, use the method using the connection reuse and optimization. For example, if a connection leak occurs because the application does not return used connections, it cannot be resolved even though you increase the connection pool count. In this case, the DB active count trend draws an upward trend graph. To prevent the connection leaks, you must manage to return the used connections. After using the connection, you can explicitly set to return it or try reusing it."})]})]})}function l(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},56962:function(e,n,t){t.d(n,{A:()=>i});let i="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik03LjUgMTMuOTMwOEw4Ljc5NTQzIDE1TDEzLjUgOS45NzkxTDguNzk1NDMgNUw3LjUgNi4wMjczN0wxMS4yMjk3IDkuOTc5MUw3LjUgMTMuOTMwOFoiIGZpbGw9IiM3NTc1NzUiLz4KPC9zdmc+Cg=="},55099:function(e,n,t){t.d(n,{A:()=>i});let i="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTcuMDIzNTEgNS45NjcxVjUuOTY2MTNMNy45NjY4NyA1LjAyMzc0TDEzLjYyMzEgMTAuNjgxTDEyLjY4MDcgMTEuNjIzNEw3Ljk2NTkgNi45MDk0OEwzLjI1MjAzIDExLjYyMzRMMi4zMDk2NSAxMC42ODFMNy4wMjM1MSA1Ljk2NzFaIiBmaWxsPSIjNzU3NTc1Ii8+Cjwvc3ZnPgo="},84429:function(e,n,t){t.d(n,{R:()=>r,x:()=>c});var i=t(96540);let o={},s=i.createContext(o);function r(e){let n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);