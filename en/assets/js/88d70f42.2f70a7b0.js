"use strict";(self.webpackChunkwhatap_docs=self.webpackChunkwhatap_docs||[]).push([["43821"],{41358:function(e,t,n){n.r(t),n.d(t,{metadata:()=>r,default:()=>h,frontMatter:()=>s,contentTitle:()=>c,toc:()=>l,assets:()=>o});var r=JSON.parse('{"id":"golang/api-guide","title":"API Guide","description":"You can use the Go library to send the data to be monitored to the WhaTap agent.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/golang/api-guide.mdx","sourceDirName":"golang","slug":"/golang/api-guide","permalink":"/whatap-docs/en/golang/api-guide","draft":false,"unlisted":false,"editUrl":"undefined/docs/golang/api-guide.mdx","tags":[],"version":"current","frontMatter":{"id":"api-guide","title":"API Guide","description":"You can use the Go library to send the data to be monitored to the WhaTap agent.","keywords":["Go","API Guide","Library"],"isTranslationMissing":false},"sidebar":"goSidebar","previous":{"title":"Installing the Docker environment","permalink":"/whatap-docs/en/golang/install-agent-docker"},"next":{"title":"Installation checking items","permalink":"/whatap-docs/en/golang/install-check"}}'),a=n(74848),i=n(84429);let s={id:"api-guide",title:"API Guide",description:"You can use the Go library to send the data to be monitored to the WhaTap agent.",keywords:["Go","API Guide","Library"],isTranslationMissing:!1},c,o={},l=[{value:"Download",id:"download",level:2},{value:"Getting started",id:"getting-started",level:2},{value:"init, shutdown",id:"init-shutdown",level:3},{value:"Context",id:"context",level:3},{value:"Generating transactions",id:"generating-transactions",level:4},{value:"Transaction tracing",id:"transaction-tracing",level:2},{value:"Web transaction trace",id:"web-transaction-trace",level:3},{value:"General transaction trace",id:"general-transaction-trace",level:3},{value:"API",id:"api",level:3},{value:"DB connection and SQL tracing",id:"db-connection-and-sql-tracing",level:2},{value:"DB Connection",id:"db-connection",level:3},{value:"Database/SQL package configuration",id:"databasesql-package-configuration",level:3},{value:"API",id:"api-1",level:3},{value:"Tracing the HTTP requests",id:"tracing-the-http-requests",level:2},{value:"http transport RoundTrip",id:"http-transport-roundtrip",level:3},{value:"API",id:"api-2",level:3},{value:"Tracing multi-transactions (distributed tracing)",id:"mtrace",level:2},{value:"Configuring the agent",id:"configuring-the-agent",level:3},{value:"Passing the Request Header",id:"passing-the-request-header",level:3},{value:"Adding the header information when accessing the HTTP",id:"adding-the-header-information-when-accessing-the-http",level:3},{value:"Adding the header automatically",id:"adding-the-header-automatically",level:3},{value:"Function tracing",id:"function-tracing",level:2},{value:"API",id:"api-3",level:3},{value:"Log",id:"log",level:2},{value:"Configuring the agent",id:"configuring-the-agent-1",level:3},{value:"Before initializing the logging library",id:"before-initializing-the-logging-library",level:3},{value:"After initializing the logging library",id:"after-initializing-the-logging-library",level:3},{value:"API",id:"api-4",level:3},{value:"log package",id:"log-package",level:4},{value:"go.uber.org/zap",id:"gouberorgzap",level:4},{value:"github.com/sirupsen/logrus",id:"githubcomsirupsenlogrus",level:4}];function d(e){let t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",section:"section",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["The example code in this document is available in the ",(0,a.jsx)(t.a,{href:"https://github.com/whatap/go-api-example",children:"github.com/whatap/go-api-example"})," repository."]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"download",children:"Download"}),(0,a.jsx)(t.p,{children:"Download the package and the related dependencies."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"go get github.com/whatap/go-api\n"})})]}),"\n",(0,a.jsx)(t.section,{className:"remark-sectionize-h2",children:(0,a.jsx)(t.h2,{id:"getting-started",children:"Getting started"})}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"init-shutdown",children:"init, shutdown"}),(0,a.jsxs)(t.p,{children:["Start the monitoring module by using the ",(0,a.jsx)(t.code,{children:"trace.Init()"})," function. ",(0,a.jsx)(t.code,{children:"defer trace.Shutdown()"})," makes sure that the monitoring ends."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-javascript",metastring:'title="Go"',children:'import "github.com/whatap/go-api/trace"\n\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n\n    ...\n}\n\nfunc Init(m map[string]string)\n'})}),(0,a.jsxs)(t.p,{children:["This can be set in the initial stage of the application by declaring it in the form of ",(0,a.jsx)(t.code,{children:"map[string]string"}),". Otherwise, more settings can be added in ",(0,a.jsx)(t.em,{children:"whatap.conf"}),". The performance information can be sent to the WhaTap collection server only when TCP connection to the agent is established normally. It performs TCP communication via ",(0,a.jsx)(t.strong,{children:"127.0.0.1:6600"})," using the basic connection information."]}),(0,a.jsxs)(t.p,{children:["To change the connection information, pass the settings to the ",(0,a.jsx)(t.code,{children:"Init"})," function, or set them in the ",(0,a.jsx)(t.em,{children:"whatap.conf"})," file and then restart the application."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'m := make(map[string]string)\nm["net_ipc_host"] = "127.0.0.1"\nm["net_ipc_port"] = "6601"\n\ntrace.Init(m)\n'})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ini",metastring:'title="whatap.conf"',children:"accesskey={access key}\nwhatap.server.host={collection server IP}\nnet_ipc_host=127.0.0.1\nnet_ipc_host=6600\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"context",children:"Context"}),(0,a.jsxs)(t.p,{children:["The agents collect performance data based on the transaction. The transactions are classified based on the ",(0,a.jsx)(t.code,{children:"context"})," to which ",(0,a.jsx)(t.code,{children:"whatap context(trace.TraceCtx)"})," belongs. The performance data that is not related to transactions is ignored or collected only as statistical data."]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h4",children:[(0,a.jsx)(t.h4,{id:"generating-transactions",children:"Generating transactions"}),(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"whatap context"})," is generated by the ",(0,a.jsx)(t.code,{children:"Start"})," and ",(0,a.jsx)(t.code,{children:"StartWithReqest"})," functions of the ",(0,a.jsx)(t.code,{children:"go-api/trace"})," module. Set the ",(0,a.jsx)(t.code,{children:"TraceCtx"})," data with the ",(0,a.jsx)(t.code,{children:"whatap"})," key in the ",(0,a.jsx)(t.code,{children:"context"}),"."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'var traceCtx *TraceCtx\ntraceCtx.Txid = keygen.Next()\nctx = context.WithValue(ctx, "whatap", traceCtx)\n'})}),(0,a.jsxs)(t.p,{children:["In APIs for transactions, SQLs, DBConnections, external HTTP requests, and general function tracing, the ",(0,a.jsx)(t.code,{children:"Context"})," in which the ",(0,a.jsx)(t.code,{children:"TraceCtx"})," object exists as the ",(0,a.jsx)(t.code,{children:"whatap"})," key is required at startup."]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"transaction-tracing",children:"Transaction tracing"}),(0,a.jsx)(t.p,{children:"It traces all transactions from web requests to responses, and traces transactions for normal work units. It consists of the startup and end functions. It is recognized as a single transaction, and you can see the detailed views on the hitmap widget and the statistical metrics such as TPS, response time, and average response time."}),(0,a.jsx)(t.p,{children:"You can collect HTTP parameters and HTTP headers through the settings."})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"web-transaction-trace",children:"Web transaction trace"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'http.HandleFunc("/index", func(w http.ResponseWriter, r *http.Request) {\n    ctx, _ := trace.StartWithRequest(r)\n    defer trace.End(ctx, nil)\n}\n'})}),(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"trace.Func()"}),", ",(0,a.jsx)(t.code,{children:"trace.HandlerFunc()"})]}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Function that wraps Handle and HandFunc of the ",(0,a.jsx)(t.code,{children:"net/http"})]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["Proceed with ",(0,a.jsx)(t.code,{children:"trace.StartWithRequest"})," and ",(0,a.jsx)(t.code,{children:"trace.End"})," in the same way."]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"The name of the web transaction is set to RequestURI."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.code,{children:"trace.Step()"})}),"\n",(0,a.jsx)(t.p,{children:"It provides the function to output the strings delivered by the user to the profile data."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'http.HandleFunc("/wrapHandleFunc", trace.Func(func(w http.ResponseWriter, r *http.Request) {\n    ...\n}))\n'})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'http.Handle("/wrapHandleFunc1", trace.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n    ...\n}))\n'})}),"\n"]}),"\n"]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"general-transaction-trace",children:"General transaction trace"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'func main() {\n    ...\n\n    ctx := context.Background()\n    ctx, _ := trace.Start(ctx, "Custom Transaction")\n\n    ...\n\n    trace.End(ctx, nil)\n\n    ...\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"api",children:"API"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Start(ctx context.Context, name string) (context.Context, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func End(ctx context.Context, err error) error\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func StartWithRequest(r *http.Request) (context.Context, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Step(ctx context.Context, title, message string, elapsed, value int) error\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func HandlerFunc(handler func(http.ResponseWriter, *http.Request)) http.HandlerFunc\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Func(handler func(http.ResponseWriter, *http.Request)) func(http.ResponseWriter, *http.Request)\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"db-connection-and-sql-tracing",children:"DB connection and SQL tracing"}),(0,a.jsx)(t.p,{children:"Execution times and errors can be collected by passing parameters for DB connection, SQL syntax, errors, and prepared statements to the API. SQL statements can be collected up to 32 KB. The parameters for SQL prepared statements are collected up to 20 and up to 256 bytes for each."})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"db-connection",children:"DB Connection"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    whatapsql "github.com/whatap/go-api/sql"\n)\n\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n    \n    ctx, _ := trace.Start(context.Background(), "Trace Open DB")\n    defer trace.End(ctx, nil)\n    \n    sqlCtx, _ := whatapsql.StartOpen(ctx, "id@tcp(x.x.x.x:3306)/test")\n    db, err := sql.Open("mysql", "id:pwd@tcp(x.x.x.x:3306)/test")\n    whatapsql.End(sqlCtx, err)\n    defer db.Close()\n}\n'})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    whatapsql "github.com/whatap/go-api/sql"\n)\n\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n    \n    ctx, _ := trace.Start(context.Background(), "Trace Query")\n    defer trace.End(ctx, nil)\n    \n    query = "select id, subject from tbl_faq limit 10"\n    sqlCtx, _ = whatapsql.Start(ctx, "id:pwd@tcp(x.x.x.x:3306)/test", query)\n    rows, err := db.QueryContext(ctx, query)\n    whatapsql.End(sqlCtx, err)\n}\n'})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    whatapsql "github.com/whatap/go-api/sql"\n)\n\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n    \n    ctx, _ := trace.Start(context.Background(), "Trace Prepared Statement")\n    defer trace.End(ctx, nil)\n    \n    // Create Prepared Statement\n    query = "select id, subject from tbl_faq where id = ? limit ?"\n    stmt, err := db.Prepare(query)\n    if err != nil {\n      return\n    }\n    defer stmt.Close()\n    \n    params := make([]interface{}, 0)\n    params = append(params, 8)\n    params = append(params, 1)\n    \n    sqlCtx, _ := whatapsql.StartWithParamArray(ctx, "id:pwd(x.x.x.x:3306)/test", query, params)\n    rows, err := stmt.QueryContext(ctx, params...)\n    whatapsql.End(sqlCtx, err)\n    \n\n    sqlCtx, _ = whatapsql.StartWithParam(ctx, "id:pwd(x.x.x.x:3306)/test", query, params...)\n    rows, err := stmt.QueryContext(ctx, params...)\n    whatapsql.End(sqlCtx, err)\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"databasesql-package-configuration",children:"Database/SQL package configuration"}),(0,a.jsxs)(t.p,{children:["Use the ",(0,a.jsx)(t.code,{children:"whatapsql.OpenContext"})," function instead of the ",(0,a.jsx)(t.code,{children:"sql.Open"})," function of the database/sql package. It is recommended to use the functions that pass the ",(0,a.jsx)(t.code,{children:"contexts"}),", such as ",(0,a.jsx)(t.code,{children:"PrepareContext"}),", ",(0,a.jsx)(t.code,{children:"QueryContext"}),", and ",(0,a.jsx)(t.code,{children:"ExecContext"}),". The ",(0,a.jsx)(t.code,{children:"context"})," to be delivered must have the whatap TraceCtx data through ",(0,a.jsx)(t.code,{children:"trace.Start()"}),"."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'\nimport (\n    _ "github.com/go-sql-driver/mysql"\n    "github.com/whatap/go-api/instrumentation/database/sql/whatapsql"\n)\n\nfunc main() {\n    config := make(map[string]string)\n    trace.Init(config)\n    defer trace.Shutdown()\n\n    // The whatap TraceCtx is generated inside whataphttp.Func.\n    http.HandleFunc("/query", whataphttp.Func(func(w http.ResponseWriter, r *http.Request){\n      ctx := r.Context()\n    \n      // Use the WhaTap Driver. It passes the contexts that have TraceCtx.\n      db, err := whatapsql.OpenContext(ctx, "mysql", dataSource)\n      if err != nil {\n        fmt.Println("Error whatapsql.Open ", err)\n        return\n      }\n      defer db.Close()\n      \n      ...\n      query := "select id, subject from tbl_faq limit 10"\n      \n      // It passes the contexts that have TraceCtx.\n      if rows, err := db.QueryContext(ctx, query); err == nil {\n        ...\n      }\n    }\n    ...\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"api-1",children:"API"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Start(ctx context.Context, dbhost, sql string) (*SqlCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func StartOpen(ctx context.Context, dbhost string) (*SqlCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func End(sqlCtx *SqlCtx, err error) error\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func StartWithParam(ctx context.Context, dbhost, sql, param ...interface{}) (*SqlCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func StartWithParamArray(ctx context.Context, dbhost, sql string, param []interface{}) (*SqlCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Trace(ctx context.Context, dbhost, sql, param string, elapsed int, err error) error\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"tracing-the-http-requests",children:"Tracing the HTTP requests"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    "github.com/whatap/go-api/httc"\n)\n\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n\n    ctx, _ := trace.Start(context.Background(), "Trace Http Call")\n    defer trace.End(ctx, nil)\n\n    httpcCtx, _ := httpc.Start(ctx, callUrl)\n    resp, err := http.Get(callUrl)\n    if err == nil {\n        httpc.End(httpcCtx, resp.StatusCode, "", nil)\n    } else {\n        httpc.End(httpcCtx, 0, "", err)\n    }\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"http-transport-roundtrip",children:"http transport RoundTrip"}),(0,a.jsx)(t.p,{children:"You can set the RoundTrip."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    "github.com/whatap/go-api/instrumentation/net/http/whataphttp"\n)\n\nfunc main() {\n    config := make(map[string]string)\n    trace.Init(config)\n    defer trace.Shutdown()\n\n    ctx, _ := trace.Start(context.Background(), "Http call")\n    defer trace.End(ctx, nil)\n\n    callUrl := "http://aaa.com/xxx"\n    client := http.DefaultClient\n    // Use WhaTap RoundTrip. Passes the context with whatap\'s TraceCtx.\n    client.Transport = whataphttp.NewRoundTrip(ctx, http.DefaultTransport)\n    resp, err := client.Get(callUrl)\n    if err != nil {\n        ...\n    }\n    defer resp.Body.Close()\n    ...\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"api-2",children:"API"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Start(ctx context.Context, url string) (*HttpcCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func End(httpcCtx *HttpcCtx, status int, reason string, err error) error\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Trace(ctx context.Context, host string, port int, url string, elapsed int, status int, reason string, err error) error\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"mtrace",children:"Tracing multi-transactions (distributed tracing)"}),(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.strong,{children:"Multi-transaction"})," means the transaction involving a different agent or project. ",(0,a.jsx)(t.strong,{children:"Multiple Transaction Trace"})," is to trace calls between the application services registered in the WhaTap project."]}),(0,a.jsxs)(t.admonition,{type:"note",children:[(0,a.jsxs)(t.p,{children:["The Go agent traces multiple transactions with three HTTP header keys (",(0,a.jsx)(t.code,{children:"x-wtap-po"}),", ",(0,a.jsx)(t.code,{children:"x-wtap-mst"}),", ",(0,a.jsx)(t.code,{children:"x-wtap-sp1"}),"). If HTTP transactions passing through the gateway are not being correlated for tracing, check the HTTP header conditions."]}),(0,a.jsx)(t.p,{children:"It supports TraceContext for open source tracing. (traceparent header tracing)"})]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"configuring-the-agent",children:"Configuring the agent"}),(0,a.jsxs)(t.p,{children:["To enable multi-transaction tracing, set the following options in the agent configuration file (",(0,a.jsx)(t.em,{children:"whatap.conf"}),")."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ini",metastring:'title="whatap.conf"',children:"# Activation option, Default: false\nmtrace_enabled=true\n\n# Sampling rate, Default: 10\nmtrace_rate=100\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"passing-the-request-header",children:"Passing the Request Header"}),(0,a.jsx)(t.p,{children:"To check the distributed tracing information (header), pass the Request Header."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'// import "github.com/whatap/go-api/trace"\nfunc UpdateMtrace(traceCtx *trace.TraceCtx, header http.Header) \n'})}),(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"trace.StartWithRequest"})," function internally calls the ",(0,a.jsx)(t.code,{children:"UpdateMtrace"})," function. If you do not use the ",(0,a.jsx)(t.code,{children:"trace.StartWithRequest"})," function, you have to directly call it and then analyze the passed header information."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'// func GetTraceContext(ctx context.Context) (context.Context, *TraceCtx)\n// if v := ctx.Value("whatap"); v != nil {\n//      return ctx, v.(*TraceCtx)\n// }\nctx, traceCtx := trace.GetTraceContext(ctx);\nif traceCtx != nil {\n    trace.UpdateMtrace(traceCtx, header)\n}\n'})}),(0,a.jsxs)(t.admonition,{type:"note",children:[(0,a.jsxs)(t.p,{children:["See the code inside the ",(0,a.jsx)(t.code,{children:"trace.Start"})," function:"]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go" showLineNumbers {6}',children:"func Start(ctx context.Context, name string) (context.Context, error) {\n    ctx, traceCtx := NewTraceContext(ctx)\n    traceCtx.Name = name\n    traceCtx.StartTime = dateutil.SystemNow()\n    // update multi trace info\n    UpdateMtrace(traceCtx, http.Header{})\n\n    ...\n"})}),(0,a.jsxs)(t.p,{children:["See the code inside the ",(0,a.jsx)(t.code,{children:"trace.StartWithRequest"})," function:"]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go" showLineNumbers {6}',children:"func StartWithRequest(r *http.Request) (context.Context, error) {\n    ctx, traceCtx := NewTraceContext(r.Context())\n    traceCtx.Name = r.RequestURI\n    traceCtx.StartTime = dateutil.SystemNow()\n    // update multi trace info\n    UpdateMtrace(traceCtx, r.Header)\n\n    ...\n"})})]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"adding-the-header-information-when-accessing-the-http",children:"Adding the header information when accessing the HTTP"}),(0,a.jsx)(t.p,{children:"When making an outbound HTTP connection, add the header information in the Request Header for tracing."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go" showLineNumbers',children:'import (\n    "github.com/whatap/go-api/trace"\n)\n\nfunc GetMTrace(ctx context.Context) http.Header\n'})}),(0,a.jsxs)(t.p,{children:["The next is the function to retrieve the headers required for distributed tracing. You have to add the returned headers to the external request. The context must contain ",(0,a.jsx)(t.code,{children:"trace.TraceContext"})," for the 'whatap' entry. The information is added internally as whatap context information when using the ",(0,a.jsx)(t.code,{children:"trace.Start"}),", ",(0,a.jsx)(t.code,{children:"StartWithRequest"}),", and ",(0,a.jsx)(t.code,{children:"StartWithContext"})," functions."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Example code" showLineNumbers {1}',children:"headers := trace.GetMTrace(wCtx)\nfor key, _ := range headers {\n    // req *http.Request\n    // The Add function is also available.\n    req.Header.Set(key, headers.Get(key))\n}\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"adding-the-header-automatically",children:"Adding the header automatically"}),(0,a.jsxs)(t.p,{children:["The WhaTap transport (RoundTrip) already has the code that uses ",(0,a.jsx)(t.code,{children:"GetMTrace"})," internally. You can automatically add header information by simply enabling its option."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Example code" showLineNumbers',children:'import (\n    "net/http"\n    "github.com/whatap/go-api/instrumentation/net/http/whataphttp"\n)\n\n...\n\n//client := http.DefaultClient\nclient := http.Client{\n    Timeout: timeout,\n}\nclient.Transport = whataphttp.NewRoundTrip(ctx, http.DefaultTransport)\nif resp, err := client.Get(callUrl); err == nil {\n    ...\n}\n'})}),(0,a.jsxs)(t.p,{children:["The following lists some usage examples of Transport: The context must contain ",(0,a.jsx)(t.code,{children:"trace.TraceContext"})," for the 'whatap' entry."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Exmple code" showLineNumbers',children:'import (\n    "net/http"\n    "github.com/whatap/go-api/instrumentation/net/http/whataphttp"\n)\n\n...\n\nclient := http.DefaultClient\nclient.Transport = NewAccessLogRoundTrip(whataphttp.NewRoundTrip(ctx, http.DefaultTransport))	\n\n...\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h2",children:[(0,a.jsx)(t.h2,{id:"function-tracing",children:"Function tracing"}),(0,a.jsx)(t.p,{children:"This API measures the execution time of the user function or desired section. API can be set before or after execution of the function."}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:'import (\n    "github.com/whatap/go-api/method"\n)\nfunc main(){\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n  \n    ctx, _ := trace.Start(context.Background(), "Trace Method")\n    defer trace.End(ctx, nil)\n  \n    getUser(ctx)\n}\n\nfunc getUser(ctx context.Context) {\n    methodCtx, _ := method.Start(ctx, "getUser")\n    defer method.End(methodCtx, nil)\n    time.Sleep(time.Duration(1) * time.Second)\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"api-3",children:"API"}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Start(ctx context.Context, name string) (*MethodCtx, error)\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func End(methodCtx *MethodCtx, err error) error\n"})}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="Go"',children:"func Trace(ctx context.Context, name string, elapsed int, err error) error\n"})})]}),"\n",(0,a.jsx)(t.section,{className:"remark-sectionize-h2",children:(0,a.jsx)(t.h2,{id:"log",children:"Log"})}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"configuring-the-agent-1",children:"Configuring the agent"}),(0,a.jsxs)(t.p,{children:["Set agent options in the ",(0,a.jsx)(t.em,{children:"whatap.conf"})," file before running the application."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ini",metastring:'title="whatap.conf"',children:"# Enable all log collection\nlogsink_enabled=true\n\n# Enable stdout collection\nlogsink_stdout_enabled=true\n\n# Enable stderr collection\nlogsink_stderr_enabled=true\n\n# Optional. This is a setting for compressing data. \nlogsin_zip_enabled=true\n"})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"before-initializing-the-logging-library",children:"Before initializing the logging library"}),(0,a.jsxs)(t.p,{children:["You must call the ",(0,a.jsx)(t.code,{children:"trace.Init()"})," function before initializing the logging library. It internally wraps ",(0,a.jsx)(t.code,{children:"os.Stdout"})," and ",(0,a.jsx)(t.code,{children:"os.Stderr"}),". Afterwards, the log library automatically collects logs when ",(0,a.jsx)(t.code,{children:"os.Stdout"})," and ",(0,a.jsx)(t.code,{children:"os.Stderr"})," have been set."]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"after-initializing-the-logging-library",children:"After initializing the logging library"}),(0,a.jsxs)(t.p,{children:["After initializing the logging library, you can set the ",(0,a.jsx)(t.strong,{children:"io.Writer"})," wrapped through a separate configuration function."]}),(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"logsink.GetWriterHookStdout()"}),": It returns ",(0,a.jsx)(t.strong,{children:"io.Writer"})," that has wrapped ",(0,a.jsx)(t.code,{children:"os.Stderr"}),". It collects the log by using the WhaTap log while outputting to ",(0,a.jsx)(t.code,{children:"os.Stdout"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"logsink.GetWriterHookStderr()"}),": It returns ",(0,a.jsx)(t.strong,{children:"io.Writer"})," that has wrapped ",(0,a.jsx)(t.code,{children:"os.Stderr"}),". The wrapped ",(0,a.jsx)(t.strong,{children:"io.Writer"})," outputs to ",(0,a.jsx)(t.code,{children:"os.Stderr"})," and collects the log contents by using the WhaTap log."]}),"\n"]}),"\n"]})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h3",children:[(0,a.jsx)(t.h3,{id:"api-4",children:"API"}),(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["It returns ",(0,a.jsx)(t.strong,{children:"io.Writer"})," that has wrapped ",(0,a.jsx)(t.code,{children:"os.Stdout"}),"."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",children:"func GetWriterHookStdout() io.Writer\n"})}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsxs)(t.p,{children:["It returns ",(0,a.jsx)(t.strong,{children:"io.Writer"})," that has wrapped ",(0,a.jsx)(t.code,{children:"os.Stderr"}),"."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",children:"func GetWriterHookStderr() io.Writer\n"})}),"\n"]}),"\n"]}),(0,a.jsx)(t.p,{children:"See the following package-specific code example:"})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h4",children:[(0,a.jsx)(t.h4,{id:"log-package",children:"log package"}),(0,a.jsxs)(t.p,{children:["The log package sets ",(0,a.jsx)(t.code,{children:"os.Stderr"})," at the ",(0,a.jsx)(t.strong,{children:"import"})," time (in the ",(0,a.jsx)(t.code,{children:"init"})," function). Because the ",(0,a.jsx)(t.code,{children:"trace.Init"})," function cannot be called first, set the wrapped ",(0,a.jsx)(t.strong,{children:"io.Writer"})," (",(0,a.jsx)(t.code,{children:"os.Stderr"}),") through the ",(0,a.jsx)(t.code,{children:"log.SetOutput"})," function."]}),(0,a.jsxs)(t.p,{children:["The output using the ",(0,a.jsx)(t.code,{children:"print"})," function of the log package used afterwards maintains in ",(0,a.jsx)(t.code,{children:"os.Stderr"})," through the wrapped ",(0,a.jsx)(t.strong,{children:"io.Writer"}),", while collecting the log contents at the same time by using the WhaTap log."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="log package"',children:'import (\n    "log"\n    "github.com/whatap/go-api/logsink"\n)\n\n...\n\nif logsink.GetWriterHookStderr() != nil {\n    // set single writer\n    log.SetOutput(logsink.GetWriterHookStderr())	\n    \n    // set multi writer \n    multi := io.MultiWriter(file, logsink.GetWriterFromStderr())\n    log.SetOutput(logsink.GetWriterHookStderr())\n}\n\n// \nlog.Println("aaaaa")\n...\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h4",children:[(0,a.jsx)(t.h4,{id:"gouberorgzap",children:"go.uber.org/zap"}),(0,a.jsxs)(t.p,{children:["If you call the ",(0,a.jsx)(t.code,{children:"trace.Init()"})," function before setting ",(0,a.jsx)(t.code,{children:"os.Stdout"}),", logs are collected automatically. It collects logs by using the WhaTap log while outputting to ",(0,a.jsx)(t.code,{children:"os.Stdout"}),"."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="go.uber.org/zap"',children:'import (\n    "github.com/whatap/go-api/trace"\n    "github.com/whatap/go-api/logsink"\n    \n    "go.uber.org/zap"\n    "go.uber.org/zap/zapcore"\n)\n\nfunc main() {\n    trace.Init(nil)\n    //It must be executed before closing the app.\n    defer trace.Shutdown()\n\n    // fmt.Println("Logger stdout=", os.Stdout, zapcore.AddSync(os.Stdout))\n    consoleCore := zapcore.NewCore(\n        zapcore.NewConsoleEncoder(consoleEncoderConfig), \n        zapcore.AddSync(os.Stdout),                      \n        zap.InfoLevel,\n    )\n\n    // Menggabungkan core file dan console\n    core := zapcore.NewTee(consoleCore)\n    Log = zap.New(core, zap.AddCaller(), zap.AddStacktrace(zapcore.ErrorLevel))\n    Log.Info("logger started")\n\n    ...\n}\n'})})]}),"\n",(0,a.jsxs)(t.section,{className:"remark-sectionize-h4",children:[(0,a.jsx)(t.h4,{id:"githubcomsirupsenlogrus",children:"github.com/sirupsen/logrus"}),(0,a.jsxs)(t.p,{children:["The wrapped ",(0,a.jsx)(t.strong,{children:"io.Writer"})," outputs to ",(0,a.jsx)(t.code,{children:"os.Stderr"})," and collects the log contents by using the WhaTap log."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-go",metastring:'title="github.com/sirupsen/logrus"',children:'package main\n\nimport (\n    "time"\n\n    log "github.com/sirupsen/logrus"\n\n    "github.com/whatap/go-api/logsink"\n    "github.com/whatap/go-api/trace"\n)\n\nfunc main() {\n    trace.Init(nil)\n    defer trace.Shutdown()\n\n    //In WhaTap, set io.Writer wrapping os.Stderr as the output of logrus\n    if logsink.GetWriterHookStderr() != nil {\n        log.SetOutput(logsink.GetWriterHookStderr())\n    }\n\n    for i := 0; i < 100; i++ {\n        log.WithFields(log.Fields{\n            "animal":  "tiger",\n            "habitat": "mountain",\n        }).Info("Index:[", i, "] A tiger appears")\n\n        time.Sleep(100 * time.Millisecond)\n    }\n}\n'})})]})]})}function h(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},84429:function(e,t,n){n.d(t,{R:()=>s,x:()=>c});var r=n(96540);let a={},i=r.createContext(a);function s(e){let t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);